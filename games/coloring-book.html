<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Coloring Book - Infinite Canvas</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-user-select:none;user-select:none}
html,body{width:100%;height:100%;overflow:hidden;font-family:'Nunito',sans-serif;background:#f0f4f8;touch-action:none}

#canvas-container{
  position:fixed;inset:0;overflow:hidden;cursor:crosshair;
  background:#ffffff;
}

canvas#main-canvas{
  position:absolute;top:0;left:0;
  image-rendering:auto;
}

.toolbar{
  position:fixed;left:50%;bottom:16px;transform:translateX(-50%);
  z-index:100;display:flex;align-items:center;gap:6px;
  background:rgba(255,255,255,.95);backdrop-filter:blur(12px);
  padding:8px 14px;border-radius:50px;
  box-shadow:0 4px 24px rgba(0,0,0,.12),0 1px 4px rgba(0,0,0,.06);
  border:1px solid rgba(0,0,0,.06);
}

.tool-btn{
  width:40px;height:40px;border-radius:50%;border:2px solid transparent;
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;font-size:18px;background:rgba(0,0,0,.04);
  transition:all .2s;flex-shrink:0;
}
.tool-btn:hover{background:rgba(0,0,0,.08)}
.tool-btn.active{border-color:#0ea5e9;background:rgba(14,165,233,.1)}

.separator{width:1px;height:28px;background:rgba(0,0,0,.1);margin:0 4px;flex-shrink:0}

.color-btn{
  width:32px;height:32px;border-radius:50%;border:3px solid rgba(255,255,255,.9);
  cursor:pointer;transition:transform .2s,box-shadow .2s;flex-shrink:0;
  box-shadow:0 2px 6px rgba(0,0,0,.15);
}
.color-btn:hover{transform:scale(1.15)}
.color-btn.active{
  border-color:#1e293b;transform:scale(1.2);
  box-shadow:0 2px 12px rgba(0,0,0,.25);
}

.size-slider{
  width:80px;height:4px;-webkit-appearance:none;appearance:none;
  background:#e2e8f0;border-radius:4px;outline:none;
}
.size-slider::-webkit-slider-thumb{
  -webkit-appearance:none;width:18px;height:18px;border-radius:50%;
  background:#0ea5e9;cursor:pointer;border:2px solid white;
  box-shadow:0 1px 4px rgba(0,0,0,.2);
}

.size-preview{
  width:28px;height:28px;display:flex;align-items:center;justify-content:center;
  flex-shrink:0;
}
.size-dot{
  border-radius:50%;background:#1e293b;
}

.back-btn{
  position:fixed;top:14px;left:14px;z-index:100;
  padding:8px 18px;background:rgba(255,255,255,.9);backdrop-filter:blur(8px);
  border:1px solid rgba(0,0,0,.08);border-radius:30px;
  color:#475569;font-size:13px;font-weight:700;cursor:pointer;
  font-family:inherit;transition:all .2s;
  box-shadow:0 2px 8px rgba(0,0,0,.06);
}
.back-btn:hover{background:#fff;color:#1e293b;box-shadow:0 4px 16px rgba(0,0,0,.1)}

.zoom-controls{
  position:fixed;top:14px;right:14px;z-index:100;
  display:flex;gap:6px;
}
.zoom-btn{
  width:36px;height:36px;border-radius:50%;
  background:rgba(255,255,255,.9);backdrop-filter:blur(8px);
  border:1px solid rgba(0,0,0,.08);
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;font-size:18px;font-weight:700;color:#475569;
  transition:all .2s;box-shadow:0 2px 8px rgba(0,0,0,.06);
  font-family:inherit;
}
.zoom-btn:hover{background:#fff;color:#1e293b}

.zoom-label{
  position:fixed;top:56px;right:14px;z-index:100;
  font-size:11px;font-weight:700;color:#94a3b8;
  text-align:center;width:78px;
}

.page-selector{
  position:fixed;top:14px;left:50%;transform:translateX(-50%);z-index:100;
  display:flex;gap:6px;align-items:center;
  background:rgba(255,255,255,.9);backdrop-filter:blur(8px);
  padding:6px 14px;border-radius:30px;
  box-shadow:0 2px 8px rgba(0,0,0,.06);
  border:1px solid rgba(0,0,0,.06);
}
.page-btn{
  padding:6px 14px;border-radius:20px;border:none;
  background:transparent;cursor:pointer;
  font-size:12px;font-weight:700;color:#64748b;
  font-family:inherit;transition:all .2s;
}
.page-btn:hover{background:rgba(0,0,0,.05)}
.page-btn.active{background:#0ea5e9;color:white}

.hint{
  position:fixed;bottom:80px;left:50%;transform:translateX(-50%);
  z-index:100;font-size:12px;font-weight:600;color:#94a3b8;
  background:rgba(255,255,255,.8);padding:6px 16px;border-radius:20px;
  pointer-events:none;opacity:1;transition:opacity 1s;
}
.hint.hidden{opacity:0}
</style>
</head>
<body>

<div id="canvas-container">
  <canvas id="main-canvas"></canvas>
</div>

<button class="back-btn" id="backBtn">&#x2190; Menu</button>

<div class="page-selector" id="pageSelector">
  <button class="page-btn active" data-page="0">Butterfly</button>
  <button class="page-btn" data-page="1">Fish</button>
  <button class="page-btn" data-page="2">Flower</button>
  <button class="page-btn" data-page="3">Star</button>
  <button class="page-btn" data-page="4">Free</button>
</div>

<div class="zoom-controls">
  <button class="zoom-btn" id="zoomIn">+</button>
  <button class="zoom-btn" id="zoomOut">&minus;</button>
  <button class="zoom-btn" id="zoomReset" style="font-size:12px">1:1</button>
</div>
<div class="zoom-label" id="zoomLabel">100%</div>

<div class="toolbar" id="toolbar">
  <button class="tool-btn active" data-tool="brush" title="Brush">&#x1F58C;&#xFE0F;</button>
  <button class="tool-btn" data-tool="fill" title="Fill">&#x1FAA3;</button>
  <button class="tool-btn" data-tool="eraser" title="Eraser">&#x1F9F9;</button>
  <button class="tool-btn" data-tool="pan" title="Pan">&#x270B;</button>

  <div class="separator"></div>

  <div class="color-btn active" data-color="#e53e3e" style="background:#e53e3e"></div>
  <div class="color-btn" data-color="#dd6b20" style="background:#dd6b20"></div>
  <div class="color-btn" data-color="#d69e2e" style="background:#d69e2e"></div>
  <div class="color-btn" data-color="#38a169" style="background:#38a169"></div>
  <div class="color-btn" data-color="#3182ce" style="background:#3182ce"></div>
  <div class="color-btn" data-color="#805ad5" style="background:#805ad5"></div>
  <div class="color-btn" data-color="#d53f8c" style="background:#d53f8c"></div>
  <div class="color-btn" data-color="#1a202c" style="background:#1a202c"></div>
  <div class="color-btn" data-color="#a0522d" style="background:#a0522d"></div>

  <div class="separator"></div>

  <input type="range" class="size-slider" id="sizeSlider" min="2" max="40" value="8">
  <div class="size-preview"><div class="size-dot" id="sizeDot"></div></div>
</div>

<div class="hint" id="hint">Pinch or scroll to zoom &middot; Two-finger drag to pan &middot; Pick a color and draw!</div>

<script>
(function(){

var container = document.getElementById('canvas-container');
var canvas = document.getElementById('main-canvas');
var ctx = canvas.getContext('2d');

var VIRTUAL_W = 4000;
var VIRTUAL_H = 4000;
canvas.width = VIRTUAL_W;
canvas.height = VIRTUAL_H;

var camera = { x: 0, y: 0, zoom: 1 };
var tool = 'brush';
var brushColor = '#e53e3e';
var brushSize = 8;
var drawing = false;
var panning = false;
var lastPt = null;
var panStart = null;
var cameraStart = null;
var pinchDist = null;
var pinchZoomStart = null;

var currentPage = 0;
var pageData = {};

var PAGES = [
  { name: 'Butterfly', draw: drawButterfly },
  { name: 'Fish', draw: drawFish },
  { name: 'Flower', draw: drawFlower },
  { name: 'Star', draw: drawStar },
  { name: 'Free', draw: null }
];

function clearCanvas() {
  ctx.fillStyle = '#ffffff';
  ctx.fillRect(0, 0, VIRTUAL_W, VIRTUAL_H);
}

function drawButterfly() {
  var cx = VIRTUAL_W / 2, cy = VIRTUAL_H / 2;
  ctx.save();
  ctx.translate(cx, cy);
  ctx.strokeStyle = '#2d3748';
  ctx.lineWidth = 3;
  ctx.lineCap = 'round';
  ctx.lineJoin = 'round';

  function wing(sx) {
    ctx.beginPath();
    ctx.moveTo(0, -20);
    ctx.bezierCurveTo(sx * 120, -200, sx * 280, -100, sx * 160, 20);
    ctx.bezierCurveTo(sx * 280, 60, sx * 200, 200, sx * 40, 120);
    ctx.bezierCurveTo(sx * 80, 180, sx * 140, 280, sx * 20, 160);
    ctx.bezierCurveTo(sx * 60, 220, sx * 20, 180, 0, 80);
    ctx.stroke();

    ctx.beginPath();
    ctx.moveTo(sx * 60, -60);
    ctx.bezierCurveTo(sx * 100, -80, sx * 140, -40, sx * 100, 0);
    ctx.bezierCurveTo(sx * 60, 20, sx * 40, -20, sx * 60, -60);
    ctx.stroke();

    ctx.beginPath();
    ctx.ellipse(sx * 80, 80, 40, 50, sx * 0.3, 0, Math.PI * 2);
    ctx.stroke();
  }
  wing(1);
  wing(-1);

  ctx.beginPath();
  ctx.ellipse(0, 40, 12, 100, 0, 0, Math.PI * 2);
  ctx.stroke();

  ctx.beginPath();
  ctx.moveTo(-4, -60);
  ctx.bezierCurveTo(-30, -140, -50, -160, -40, -180);
  ctx.stroke();
  ctx.beginPath();
  ctx.arc(-40, -184, 6, 0, Math.PI * 2);
  ctx.stroke();

  ctx.beginPath();
  ctx.moveTo(4, -60);
  ctx.bezierCurveTo(30, -140, 50, -160, 40, -180);
  ctx.stroke();
  ctx.beginPath();
  ctx.arc(40, -184, 6, 0, Math.PI * 2);
  ctx.stroke();

  ctx.restore();
}

function drawFish() {
  var cx = VIRTUAL_W / 2, cy = VIRTUAL_H / 2;
  ctx.save();
  ctx.translate(cx, cy);
  ctx.strokeStyle = '#2d3748';
  ctx.lineWidth = 3;
  ctx.lineCap = 'round';
  ctx.lineJoin = 'round';

  ctx.beginPath();
  ctx.moveTo(-200, 0);
  ctx.bezierCurveTo(-160, -120, 80, -140, 160, -40);
  ctx.bezierCurveTo(200, -20, 200, 20, 160, 40);
  ctx.bezierCurveTo(80, 140, -160, 120, -200, 0);
  ctx.stroke();

  ctx.beginPath();
  ctx.moveTo(-200, 0);
  ctx.lineTo(-300, -80);
  ctx.bezierCurveTo(-260, -20, -260, 20, -300, 80);
  ctx.lineTo(-200, 0);
  ctx.stroke();

  ctx.beginPath();
  ctx.arc(100, -20, 20, 0, Math.PI * 2);
  ctx.stroke();
  ctx.beginPath();
  ctx.arc(105, -22, 8, 0, Math.PI * 2);
  ctx.stroke();

  ctx.beginPath();
  ctx.moveTo(160, 0);
  ctx.lineTo(180, -10);
  ctx.stroke();

  for (var i = 0; i < 5; i++) {
    var x = -120 + i * 50;
    ctx.beginPath();
    ctx.moveTo(x, -60 + Math.abs(i - 2) * 10);
    ctx.bezierCurveTo(x + 10, -20, x + 10, 20, x, 60 - Math.abs(i - 2) * 10);
    ctx.stroke();
  }

  ctx.beginPath();
  ctx.moveTo(-40, -80);
  ctx.bezierCurveTo(-20, -140, 20, -140, 0, -80);
  ctx.stroke();

  ctx.beginPath();
  ctx.moveTo(-60, 70);
  ctx.bezierCurveTo(-40, 130, -10, 120, -20, 70);
  ctx.stroke();

  ctx.restore();
}

function drawFlower() {
  var cx = VIRTUAL_W / 2, cy = VIRTUAL_H / 2 - 60;
  ctx.save();
  ctx.translate(cx, cy);
  ctx.strokeStyle = '#2d3748';
  ctx.lineWidth = 3;
  ctx.lineCap = 'round';

  for (var i = 0; i < 8; i++) {
    ctx.save();
    ctx.rotate((i / 8) * Math.PI * 2);
    ctx.beginPath();
    ctx.ellipse(0, -100, 45, 80, 0, 0, Math.PI * 2);
    ctx.stroke();
    ctx.restore();
  }

  ctx.beginPath();
  ctx.arc(0, 0, 50, 0, Math.PI * 2);
  ctx.stroke();

  ctx.beginPath();
  ctx.arc(-12, -10, 8, 0, Math.PI * 2);
  ctx.stroke();
  ctx.beginPath();
  ctx.arc(12, -10, 8, 0, Math.PI * 2);
  ctx.stroke();

  ctx.beginPath();
  ctx.moveTo(0, 50);
  ctx.bezierCurveTo(10, 150, -10, 250, 0, 340);
  ctx.stroke();

  ctx.beginPath();
  ctx.moveTo(-5, 160);
  ctx.bezierCurveTo(-80, 120, -100, 140, -80, 180);
  ctx.bezierCurveTo(-60, 200, -20, 180, -5, 160);
  ctx.stroke();

  ctx.beginPath();
  ctx.moveTo(5, 220);
  ctx.bezierCurveTo(80, 180, 100, 200, 80, 240);
  ctx.bezierCurveTo(60, 260, 20, 240, 5, 220);
  ctx.stroke();

  ctx.restore();
}

function drawStar() {
  var cx = VIRTUAL_W / 2, cy = VIRTUAL_H / 2;
  ctx.save();
  ctx.translate(cx, cy);
  ctx.strokeStyle = '#2d3748';
  ctx.lineWidth = 3;
  ctx.lineCap = 'round';
  ctx.lineJoin = 'round';

  function star(x, y, r1, r2, points) {
    ctx.beginPath();
    for (var i = 0; i < points * 2; i++) {
      var a = (i / (points * 2)) * Math.PI * 2 - Math.PI / 2;
      var r = i % 2 === 0 ? r1 : r2;
      if (i === 0) ctx.moveTo(x + Math.cos(a) * r, y + Math.sin(a) * r);
      else ctx.lineTo(x + Math.cos(a) * r, y + Math.sin(a) * r);
    }
    ctx.closePath();
    ctx.stroke();
  }

  star(0, 0, 200, 80, 5);
  star(0, 0, 120, 50, 5);
  ctx.beginPath();
  ctx.arc(0, 0, 40, 0, Math.PI * 2);
  ctx.stroke();

  ctx.beginPath();
  ctx.arc(-10, -8, 6, 0, Math.PI * 2);
  ctx.stroke();
  ctx.beginPath();
  ctx.arc(10, -8, 6, 0, Math.PI * 2);
  ctx.stroke();
  ctx.beginPath();
  ctx.arc(0, 8, 12, 0, Math.PI, false);
  ctx.stroke();

  var smallStarPositions = [
    [-280, -180], [260, -200], [-300, 120], [290, 150],
    [-180, -280], [200, 280], [0, -300], [-100, 260]
  ];
  smallStarPositions.forEach(function(p) {
    star(p[0], p[1], 25, 10, 5);
  });

  ctx.restore();
}

function loadPage(idx) {
  pageData[currentPage] = ctx.getImageData(0, 0, VIRTUAL_W, VIRTUAL_H);
  currentPage = idx;

  if (pageData[idx]) {
    ctx.putImageData(pageData[idx], 0, 0);
  } else {
    clearCanvas();
    if (PAGES[idx].draw) PAGES[idx].draw();
  }

  camera.x = 0;
  camera.y = 0;
  camera.zoom = 1;
  updateTransform();
  updateZoomLabel();

  document.querySelectorAll('.page-btn').forEach(function(b) {
    b.classList.toggle('active', parseInt(b.dataset.page) === idx);
  });
}

function updateTransform() {
  var tx = (container.clientWidth / 2) - (VIRTUAL_W / 2 + camera.x) * camera.zoom;
  var ty = (container.clientHeight / 2) - (VIRTUAL_H / 2 + camera.y) * camera.zoom;
  canvas.style.transform = 'translate(' + tx + 'px,' + ty + 'px) scale(' + camera.zoom + ')';
  canvas.style.transformOrigin = '0 0';
}

function updateZoomLabel() {
  document.getElementById('zoomLabel').textContent = Math.round(camera.zoom * 100) + '%';
}

function screenToCanvas(sx, sy) {
  var tx = (container.clientWidth / 2) - (VIRTUAL_W / 2 + camera.x) * camera.zoom;
  var ty = (container.clientHeight / 2) - (VIRTUAL_H / 2 + camera.y) * camera.zoom;
  return {
    x: (sx - tx) / camera.zoom,
    y: (sy - ty) / camera.zoom
  };
}

function setZoom(z, cx, cy) {
  var oldZoom = camera.zoom;
  camera.zoom = Math.max(0.1, Math.min(10, z));
  if (cx !== undefined && cy !== undefined) {
    var pt = screenToCanvas(cx, cy);
    camera.x += (pt.x - VIRTUAL_W / 2) * (1 - camera.zoom / oldZoom) * (oldZoom / camera.zoom);
    camera.y += (pt.y - VIRTUAL_H / 2) * (1 - camera.zoom / oldZoom) * (oldZoom / camera.zoom);
  }
  updateTransform();
  updateZoomLabel();
}

function drawStroke(x0, y0, x1, y1) {
  ctx.lineCap = 'round';
  ctx.lineJoin = 'round';
  ctx.lineWidth = brushSize;

  if (tool === 'eraser') {
    ctx.globalCompositeOperation = 'destination-out';
    ctx.strokeStyle = 'rgba(0,0,0,1)';
  } else {
    ctx.globalCompositeOperation = 'source-over';
    ctx.strokeStyle = brushColor;
  }

  ctx.beginPath();
  ctx.moveTo(x0, y0);
  ctx.lineTo(x1, y1);
  ctx.stroke();
  ctx.globalCompositeOperation = 'source-over';
}

function drawDot(x, y) {
  if (tool === 'eraser') {
    ctx.globalCompositeOperation = 'destination-out';
    ctx.fillStyle = 'rgba(0,0,0,1)';
  } else {
    ctx.globalCompositeOperation = 'source-over';
    ctx.fillStyle = brushColor;
  }
  ctx.beginPath();
  ctx.arc(x, y, brushSize / 2, 0, Math.PI * 2);
  ctx.fill();
  ctx.globalCompositeOperation = 'source-over';
}

function floodFill(startX, startY, fillR, fillG, fillB) {
  var sx = Math.round(startX);
  var sy = Math.round(startY);
  if (sx < 0 || sx >= VIRTUAL_W || sy < 0 || sy >= VIRTUAL_H) return;

  var imageData = ctx.getImageData(0, 0, VIRTUAL_W, VIRTUAL_H);
  var data = imageData.data;
  var idx = (sy * VIRTUAL_W + sx) * 4;
  var targetR = data[idx], targetG = data[idx + 1], targetB = data[idx + 2], targetA = data[idx + 3];

  if (targetR === fillR && targetG === fillG && targetB === fillB && targetA === 255) return;

  var tolerance = 32;
  function matches(i) {
    return Math.abs(data[i] - targetR) <= tolerance &&
           Math.abs(data[i + 1] - targetG) <= tolerance &&
           Math.abs(data[i + 2] - targetB) <= tolerance &&
           Math.abs(data[i + 3] - targetA) <= tolerance;
  }

  var stack = [[sx, sy]];
  var visited = new Uint8Array(VIRTUAL_W * VIRTUAL_H);
  var maxPixels = 2000000;
  var count = 0;

  while (stack.length > 0 && count < maxPixels) {
    var pt = stack.pop();
    var px = pt[0], py = pt[1];
    if (px < 0 || px >= VIRTUAL_W || py < 0 || py >= VIRTUAL_H) continue;
    var vi = py * VIRTUAL_W + px;
    if (visited[vi]) continue;
    visited[vi] = 1;
    var pi = vi * 4;
    if (!matches(pi)) continue;

    data[pi] = fillR;
    data[pi + 1] = fillG;
    data[pi + 2] = fillB;
    data[pi + 3] = 255;
    count++;

    stack.push([px + 1, py], [px - 1, py], [px, py + 1], [px, py - 1]);
  }

  ctx.putImageData(imageData, 0, 0);
}

function hexToRgb(hex) {
  var r = parseInt(hex.slice(1, 3), 16);
  var g = parseInt(hex.slice(3, 5), 16);
  var b = parseInt(hex.slice(5, 7), 16);
  return [r, g, b];
}

function onPointerDown(e) {
  if (e.target.closest('.toolbar,.back-btn,.zoom-controls,.page-selector,.zoom-label')) return;
  var pt = screenToCanvas(e.clientX, e.clientY);

  if (tool === 'pan' || e.button === 1) {
    panning = true;
    panStart = { x: e.clientX, y: e.clientY };
    cameraStart = { x: camera.x, y: camera.y };
    container.style.cursor = 'grabbing';
    return;
  }

  if (tool === 'fill') {
    var rgb = hexToRgb(brushColor);
    floodFill(pt.x, pt.y, rgb[0], rgb[1], rgb[2]);
    return;
  }

  drawing = true;
  lastPt = pt;
  drawDot(pt.x, pt.y);
}

function onPointerMove(e) {
  if (panning) {
    var dx = (e.clientX - panStart.x) / camera.zoom;
    var dy = (e.clientY - panStart.y) / camera.zoom;
    camera.x = cameraStart.x - dx;
    camera.y = cameraStart.y - dy;
    updateTransform();
    return;
  }

  if (!drawing) return;
  var pt = screenToCanvas(e.clientX, e.clientY);
  if (lastPt) drawStroke(lastPt.x, lastPt.y, pt.x, pt.y);
  lastPt = pt;
}

function onPointerUp() {
  drawing = false;
  panning = false;
  lastPt = null;
  panStart = null;
  if (tool === 'pan') container.style.cursor = 'grab';
  else container.style.cursor = 'crosshair';
}

container.addEventListener('pointerdown', onPointerDown);
container.addEventListener('pointermove', onPointerMove);
container.addEventListener('pointerup', onPointerUp);
container.addEventListener('pointerleave', onPointerUp);
container.addEventListener('pointercancel', onPointerUp);

container.addEventListener('wheel', function(e) {
  e.preventDefault();
  var delta = e.deltaY > 0 ? 0.9 : 1.1;
  setZoom(camera.zoom * delta, e.clientX, e.clientY);
}, { passive: false });

container.addEventListener('touchstart', function(e) {
  if (e.touches.length === 2) {
    drawing = false;
    lastPt = null;
    var dx = e.touches[0].clientX - e.touches[1].clientX;
    var dy = e.touches[0].clientY - e.touches[1].clientY;
    pinchDist = Math.hypot(dx, dy);
    pinchZoomStart = camera.zoom;
    var mx = (e.touches[0].clientX + e.touches[1].clientX) / 2;
    var my = (e.touches[0].clientY + e.touches[1].clientY) / 2;
    panStart = { x: mx, y: my };
    cameraStart = { x: camera.x, y: camera.y };
    panning = true;
  }
}, { passive: false });

container.addEventListener('touchmove', function(e) {
  if (e.touches.length === 2 && pinchDist) {
    e.preventDefault();
    var dx = e.touches[0].clientX - e.touches[1].clientX;
    var dy = e.touches[0].clientY - e.touches[1].clientY;
    var dist = Math.hypot(dx, dy);
    var scale = dist / pinchDist;
    setZoom(pinchZoomStart * scale);

    var mx = (e.touches[0].clientX + e.touches[1].clientX) / 2;
    var my = (e.touches[0].clientY + e.touches[1].clientY) / 2;
    var ddx = (mx - panStart.x) / camera.zoom;
    var ddy = (my - panStart.y) / camera.zoom;
    camera.x = cameraStart.x - ddx;
    camera.y = cameraStart.y - ddy;
    updateTransform();
  }
}, { passive: false });

container.addEventListener('touchend', function(e) {
  if (e.touches.length < 2) {
    pinchDist = null;
    pinchZoomStart = null;
    panning = false;
  }
});

document.querySelectorAll('.tool-btn').forEach(function(btn) {
  btn.addEventListener('click', function() {
    document.querySelectorAll('.tool-btn').forEach(function(b) { b.classList.remove('active'); });
    this.classList.add('active');
    tool = this.dataset.tool;
    container.style.cursor = tool === 'pan' ? 'grab' : 'crosshair';
  });
});

document.querySelectorAll('.color-btn').forEach(function(btn) {
  btn.addEventListener('click', function() {
    document.querySelectorAll('.color-btn').forEach(function(b) { b.classList.remove('active'); });
    this.classList.add('active');
    brushColor = this.dataset.color;
    if (tool === 'eraser') {
      tool = 'brush';
      document.querySelectorAll('.tool-btn').forEach(function(b) {
        b.classList.toggle('active', b.dataset.tool === 'brush');
      });
    }
  });
});

var sizeSlider = document.getElementById('sizeSlider');
var sizeDot = document.getElementById('sizeDot');
function updateSizeDot() {
  brushSize = parseInt(sizeSlider.value);
  var s = Math.max(4, brushSize);
  sizeDot.style.width = s + 'px';
  sizeDot.style.height = s + 'px';
}
sizeSlider.addEventListener('input', updateSizeDot);
updateSizeDot();

document.getElementById('zoomIn').addEventListener('click', function() {
  setZoom(camera.zoom * 1.3, container.clientWidth / 2, container.clientHeight / 2);
});
document.getElementById('zoomOut').addEventListener('click', function() {
  setZoom(camera.zoom / 1.3, container.clientWidth / 2, container.clientHeight / 2);
});
document.getElementById('zoomReset').addEventListener('click', function() {
  camera.x = 0; camera.y = 0; camera.zoom = 1;
  updateTransform(); updateZoomLabel();
});

document.querySelectorAll('.page-btn').forEach(function(btn) {
  btn.addEventListener('click', function() {
    loadPage(parseInt(this.dataset.page));
  });
});

document.getElementById('backBtn').addEventListener('click', function() {
  location.href = '../index.html';
});

setTimeout(function() {
  document.getElementById('hint').classList.add('hidden');
}, 5000);

clearCanvas();
PAGES[0].draw();
updateTransform();

window.addEventListener('resize', function() { updateTransform(); });

})();
</script>
</body>
</html>

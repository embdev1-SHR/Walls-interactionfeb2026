<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Forest Animals Showcase</title>
<script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.3.0/model-viewer.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box;touch-action:manipulation;-webkit-tap-highlight-color:transparent}
html,body{width:100%;height:100%;overflow:hidden}
body{
  font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
  background:#071a10;color:white;
  -webkit-user-select:none;user-select:none;
}

.scene{position:fixed;inset:0;z-index:0;pointer-events:none;overflow:hidden}
.firefly{
  position:absolute;width:4px;height:4px;border-radius:50%;
  background:#ffd54f;box-shadow:0 0 8px 3px rgba(255,213,79,.5);
  animation:fly var(--dur) ease-in-out infinite;
}
@keyframes fly{
  0%{opacity:0;transform:translate(0,0)}
  25%{opacity:1}50%{opacity:.3;transform:translate(var(--dx),var(--dy))}
  75%{opacity:1}100%{opacity:0;transform:translate(0,0)}
}
.leaf{
  position:absolute;font-size:16px;opacity:0;
  animation:leafDrop var(--dur) linear infinite;
}
@keyframes leafDrop{
  0%{transform:translate(0,-20px) rotate(0);opacity:0}
  10%{opacity:.6}90%{opacity:.4}
  100%{transform:translate(var(--dx),100vh) rotate(720deg);opacity:0}
}

.app{position:relative;z-index:1;width:100%;height:100%;display:flex;flex-direction:column}

.header{flex-shrink:0;text-align:center;padding:10px 20px 4px}
.header h1{font-size:clamp(16px,2.4vw,24px);font-weight:800;color:#a5d6a7;text-shadow:0 3px 12px rgba(0,0,0,.6)}
.header p{font-size:clamp(9px,1.1vw,12px);color:rgba(255,255,255,.4)}

.scroll-area{
  flex:1;min-height:0;position:relative;
  display:flex;align-items:center;
  padding:6px 0;
}
.scroll-track{
  display:flex;gap:12px;
  overflow-x:auto;overflow-y:hidden;
  padding:0 44px;
  scroll-snap-type:x mandatory;
  scroll-behavior:smooth;
  -webkit-overflow-scrolling:touch;
  scrollbar-width:none;
}
.scroll-track::-webkit-scrollbar{display:none}

.arrow-btn{
  position:absolute;top:50%;transform:translateY(-50%);
  width:clamp(30px,3vw,38px);height:clamp(30px,3vw,38px);
  border-radius:50%;
  background:rgba(0,0,0,.6);backdrop-filter:blur(8px);
  border:2px solid rgba(129,199,132,.35);
  color:white;font-size:clamp(12px,1.4vw,16px);
  cursor:pointer;z-index:10;
  display:flex;align-items:center;justify-content:center;
  transition:all .3s;
}
.arrow-btn:hover{background:rgba(129,199,132,.2);border-color:rgba(129,199,132,.6)}
.arrow-btn:active{transform:translateY(-50%) scale(.92)}
.arrow-left{left:4px}
.arrow-right{right:4px}

.card{
  flex-shrink:0;
  width:clamp(200px,20vw,260px);
  max-height:clamp(340px,48vh,480px);
  scroll-snap-align:center;
  background:rgba(255,255,255,.04);
  border:1px solid rgba(129,199,132,.2);
  border-radius:14px;
  display:flex;flex-direction:column;
  overflow:hidden;
  transition:border-color .3s,box-shadow .3s;
}
.card:hover{
  border-color:rgba(129,199,132,.45);
  box-shadow:0 4px 20px rgba(0,0,0,.4),0 0 16px rgba(129,199,132,.08);
}

.model-area{
  flex-shrink:0;
  height:clamp(180px,24vh,280px);
  background:rgba(0,0,0,.3);
  display:flex;align-items:center;justify-content:center;
  position:relative;overflow:hidden;
  border-bottom:1px solid rgba(129,199,132,.12);
  cursor:grab;
  touch-action:none;
}
.model-area:active{cursor:grabbing}
model-viewer.animal-viewer{
  width:100%;height:100%;
  --poster-color:transparent;
  background:rgba(0,0,0,.3);
  touch-action:none;
}
.model-placeholder{
  perspective:250px;
  width:70px;height:70px;
  position:relative;
}
.cube{
  width:100%;height:100%;position:relative;
  transform-style:preserve-3d;
  transition:transform .05s linear;
}
.cube-face{
  position:absolute;width:70px;height:70px;
  display:flex;align-items:center;justify-content:center;
  font-size:38px;
  border:2px solid rgba(129,199,132,.3);
  background:rgba(15,40,25,.8);
  backface-visibility:visible;
}
.cube-face:nth-child(1){transform:rotateY(0deg) translateZ(35px)}
.cube-face:nth-child(2){transform:rotateY(90deg) translateZ(35px)}
.cube-face:nth-child(3){transform:rotateY(180deg) translateZ(35px)}
.cube-face:nth-child(4){transform:rotateY(-90deg) translateZ(35px)}
.cube-face:nth-child(5){transform:rotateX(90deg) translateZ(35px)}
.cube-face:nth-child(6){transform:rotateX(-90deg) translateZ(35px)}
.model-badge{
  position:absolute;bottom:4px;right:6px;
  font-size:8px;color:rgba(255,255,255,.3);
  background:rgba(0,0,0,.4);padding:2px 6px;border-radius:6px;
}

.card-body{
  flex:1;padding:8px 12px;display:flex;flex-direction:column;gap:4px;
  overflow-y:auto;min-height:0;
}
.card-body::-webkit-scrollbar{width:3px}
.card-body::-webkit-scrollbar-thumb{background:rgba(129,199,132,.25);border-radius:3px}

.card-top{display:flex;align-items:center;gap:8px;margin-bottom:1px}
.card-emoji{font-size:clamp(22px,2.5vw,30px);filter:drop-shadow(0 3px 8px rgba(0,0,0,.5))}
.card-titles{display:flex;flex-direction:column}
.card-name{font-size:clamp(12px,1.3vw,16px);font-weight:700;color:#a5d6a7;line-height:1.2}
.card-latin{font-size:clamp(8px,.8vw,10px);font-style:italic;color:rgba(255,255,255,.3)}

.card-desc{font-size:clamp(9px,.95vw,11px);color:rgba(255,255,255,.6);line-height:1.45}

.facts-list{list-style:none;padding:0;display:flex;flex-direction:column;gap:2px}
.facts-list li{
  font-size:clamp(9px,.85vw,11px);color:rgba(255,255,255,.65);
  line-height:1.4;padding:2px 0 2px 14px;position:relative;
}
.facts-list li::before{
  content:'';position:absolute;left:1px;top:50%;transform:translateY(-50%);
  width:6px;height:6px;border-radius:50%;
  background:rgba(129,199,132,.5);border:1px solid rgba(129,199,132,.7);
}
.facts-list li:nth-child(2)::before{background:rgba(255,193,7,.5);border-color:rgba(255,193,7,.7)}
.facts-list li:nth-child(3)::before{background:rgba(79,195,247,.5);border-color:rgba(79,195,247,.7)}

.card-sound{
  display:inline-flex;align-items:center;gap:4px;
  padding:4px 10px;margin-top:auto;align-self:flex-start;
  background:rgba(129,199,132,.1);border:1px solid rgba(129,199,132,.3);
  border-radius:14px;color:#a5d6a7;
  font-size:clamp(8px,.9vw,11px);font-weight:600;
  cursor:pointer;transition:all .3s;flex-shrink:0;
}
.card-sound:hover,.card-sound:active{background:rgba(129,199,132,.22)}
.card-sound.playing{background:rgba(129,199,132,.3);border-color:rgba(129,199,132,.6)}

.footer{
  flex-shrink:0;text-align:center;
  padding:4px 20px 10px;
}
.btn-back{
  padding:6px 22px;font-size:13px;font-weight:600;
  background:rgba(129,199,132,.1);border:2px solid rgba(129,199,132,.3);
  color:white;border-radius:50px;cursor:pointer;
  transition:all .3s;backdrop-filter:blur(8px);
}
.btn-back:hover,.btn-back:active{background:rgba(129,199,132,.2);border-color:rgba(129,199,132,.5)}

.touch-ring{
  position:fixed;width:60px;height:60px;
  border:3px solid rgba(129,199,132,.6);border-radius:50%;
  pointer-events:none;z-index:9999;
  transform:translate(-50%,-50%) scale(0);
  animation:ringPop .6s ease forwards;
}
@keyframes ringPop{
  0%{transform:translate(-50%,-50%) scale(0);opacity:1}
  100%{transform:translate(-50%,-50%) scale(2);opacity:0}
}
</style>
</head>
<body>
<audio id="forest-music" preload="auto" loop>
  <source src="../assets/Audio/capaholiczsfx-forest-daytime-446356.mp3" type="audio/mpeg">
</audio>

<div class="scene" id="scene"></div>

<div class="app">
  <div class="header">
    <h1>Forest Animals Showcase</h1>
    <p>Drag to rotate 3D models -- tap to hear sounds</p>
  </div>

  <div class="scroll-area">
    <button class="arrow-btn arrow-left" id="prevBtn">&#9664;</button>
    <div class="scroll-track" id="scrollTrack"></div>
    <button class="arrow-btn arrow-right" id="nextBtn">&#9654;</button>
  </div>

  <div class="footer">
    <div style="display:flex;gap:8px;justify-content:center;align-items:center;margin-bottom:8px">
      <button id="audioToggle" style="padding:6px 16px;font-size:13px;font-weight:600;background:rgba(129,199,132,.1);border:2px solid rgba(129,199,132,.3);color:white;border-radius:50px;cursor:pointer;transition:all .3s;backdrop-filter:blur(8px);width:fit-content">ðŸ”Š Music</button>
    </div>
    <button class="btn-back" id="backBtn">Back to Menu</button>
  </div>
</div>

<script>
var ANIMALS = [
  {
    name:'Red Deer', latin:'Cervus elaphus', emoji:'\uD83E\uDD8C',
    desc:'Majestic woodland herbivores. Males grow impressive antlers each year.',
    facts:[
      'Antlers grow up to 1 inch per day!',
      'Can run at 40 mph',
      'Babies are born with white spots for camouflage'
    ],
    sound:{type:'bellow',freq:130,dur:0.9},
    model:'../3dmodels/Deer.glb'
  },
  {
    name:'Red Fox', latin:'Vulpes vulpes', emoji:'\uD83E\uDD8A',
    desc:'Clever predators with exceptional hearing. Most widespread wild carnivore.',
    facts:[
      'Can hear a watch ticking from 40 yards away!',
      'Use Earth\'s magnetic field to hunt',
      'Have over 40 different calls'
    ],
    sound:{type:'bark',freq:800,dur:0.12},
    model:'../3dmodels/red_fox_standing_pose_realistic.glb'
  },
  {
    name:'Brown Bear', latin:'Ursus arctos', emoji:'\uD83D\uDC3B',
    desc:'Powerful omnivores among the largest land predators on Earth.',
    facts:[
      'Can eat 90 pounds of food per day!',
      'Sprint at 35 mph',
      'Hibernate for 5 to 7 months'
    ],
    sound:{type:'growl',freq:75,dur:1.2},
    model:'../3dmodels/bear.glb'
  },
  {
    name:'Great Horned Owl', latin:'Bubo virginianus', emoji:'\uD83E\uDD89',
    desc:'Silent nocturnal hunters with extraordinary night vision.',
    facts:[
      'Can turn their head 270 degrees!',
      'Fly in complete silence',
      'Grip strength is 300 PSI'
    ],
    sound:{type:'hoot',freq:300,dur:0.4},
    model:'../3dmodels/owl.glb'
  },
  {
    name:'Raccoon', latin:'Procyon lotor', emoji:'\uD83E\uDD9D',
    desc:'Curious creatures famous for masked faces and dexterous paws.',
    facts:[
      'Remember puzzles for 3 years!',
      'Paws are like tiny human hands',
      'Wash food in water before eating'
    ],
    sound:{type:'chitter',freq:600,dur:0.06},
    model:'../3dmodels/racoon.glb'
  },
  {
    name:'Red Squirrel', latin:'Sciurus vulgaris', emoji:'\uD83D\uDC3F\uFE0F',
    desc:'Acrobatic woodland gymnasts leaping between treetops.',
    facts:[
      'Bury 10,000 nuts each autumn!',
      'Leap 10x their body length',
      'Plant trees by forgetting buried nuts'
    ],
    sound:{type:'chirp',freq:900,dur:0.15},
    model:'../3dmodels/realistic_squirrel_3d_model.glb'
  },
  {
    name:'Beaver', latin:'Castor fiber', emoji:'\uD83E\uDDAB',
    desc:'Nature\'s engineers reshaping landscapes with dams and lodges.',
    facts:[
      'Dams can stretch over 800 meters!',
      'Hold breath for 15 minutes',
      'Teeth contain iron -- super strong!'
    ],
    sound:{type:'slap',freq:200,dur:0.15},
    model:'../3dmodels/realistic_beaver__castor_3d_model.glb'
  },
  {
    name:'Grey Wolf', latin:'Canis lupus', emoji:'\uD83D\uDC3A',
    desc:'Social pack hunters with complex communication.',
    facts:[
      'Howls heard from 16 km away!',
      'Each howl is unique like a fingerprint',
      'Travel 50 miles in a single day'
    ],
    sound:{type:'howl',freq:220,dur:2.0},
    model:'../3dmodels/wolf.glb'
  },
  {
    name:'Golden Eagle', latin:'Aquila chrysaetos', emoji:'\uD83E\uDD85',
    desc:'Apex aerial predators with incredible eyesight.',
    facts:[
      'Dive at speeds up to 240 km/h!',
      'Spot a rabbit from 3 km away',
      'Mate for life'
    ],
    sound:{type:'screech',freq:1800,dur:0.6},
    model:'../3dmodels/day_23_-_wild_eagle.glb'
  },
  {
    name:'Hedgehog', latin:'Erinaceus europaeus', emoji:'\uD83E\uDD94',
    desc:'Tiny nocturnal insectivores covered in protective spines.',
    facts:[
      'Covered in about 7,000 spines!',
      'Curl into a tight spiky ball',
      'Immune to some snake venoms'
    ],
    sound:{type:'snuffle',freq:400,dur:0.5}
  },
  {
    name:'Forest Gecko', latin:'Phelsuma grandis', emoji:'\uD83E\uDD8E',
    desc:'Masters of camouflage and climbing any surface.',
    facts:[
      'Can regrow their tail!',
      'Lick their eyeballs to clean them',
      'Walk on ceilings'
    ],
    sound:{type:'click',freq:1500,dur:0.04},
    model:'../3dmodels/gecko_thinker.glb'
  },
  {
    name:'European Hare', latin:'Lepus europaeus', emoji:'\uD83D\uDC07',
    desc:'Lightning-fast runners born ready to sprint from day one.',
    facts:[
      'Sprint at 70 km/h!',
      'Jump 3 meters high from standing',
      'Nearly 360-degree vision'
    ],
    sound:{type:'thump',freq:55,dur:0.12},
    model:'../3dmodels/rabbit.glb'
  },
  {
    name:'Lion', latin:'Panthera leo', emoji:'\uD83E\uDD81',
    desc:'Majestic kings of the savanna, known for powerful roars and social prides.',
    facts:[
      'Roars can be heard 8 km away!',
      'Sleep up to 20 hours a day',
      'Females do most of the hunting'
    ],
    sound:{type:'roar',freq:100,dur:1.5},
    model:'../3dmodels/lion_lowpoly.glb'
  },
  {
    name:'Tiger', latin:'Panthera tigris', emoji:'\uD83D\uDC2F',
    desc:'The largest wild cat species, with unique stripe patterns like fingerprints.',
    facts:[
      'No two tigers have the same stripes!',
      'Can leap over 9 meters forward',
      'Excellent swimmers unlike most cats'
    ],
    sound:{type:'roar',freq:90,dur:1.3},
    model:'../3dmodels/tiger.glb'
  },
  {
    name:'Elephant', latin:'Loxodonta africana', emoji:'\uD83D\uDC18',
    desc:'The largest land animals, with incredible memory and deep family bonds.',
    facts:[
      'Can recognize themselves in mirrors!',
      'Communicate through ground vibrations',
      'Herds are led by wise matriarchs'
    ],
    sound:{type:'trumpet',freq:350,dur:0.8},
    model:'../3dmodels/elephant__gajah.glb'
  }
];

var track = document.getElementById('scrollTrack');

function resolveModelPath(relPath) {
  if (typeof process !== 'undefined' && process.versions && process.versions.electron) {
    var path = require('path');
    var fs = require('fs');
    var appPath = path.dirname(__dirname);
    var normal = path.join(appPath, relPath.replace(/^\.\.\//, ''));
    var unpacked = normal.replace('app.asar', 'app.asar.unpacked');
    if (fs.existsSync(unpacked)) return 'file://' + unpacked.replace(/\\/g, '/');
    if (fs.existsSync(normal)) return 'file://' + normal.replace(/\\/g, '/');
  }
  return relPath;
}

function buildCards() {
  ANIMALS.forEach(function(animal, idx) {
    var card = document.createElement('div');
    card.className = 'card';

    var factsHtml = '';
    animal.facts.forEach(function(f) { factsHtml += '<li>' + f + '</li>'; });

    var modelHtml;
    if (animal.model) {
      var modelSrc = resolveModelPath(animal.model);
      modelHtml =
        '<div class="model-area" data-idx="' + idx + '">' +
          '<model-viewer class="animal-viewer" src="' + modelSrc + '" auto-rotate camera-controls interaction-prompt="none" shadow-intensity="0.8" exposure="1.5" environment-image="neutral" camera-orbit="0deg 75deg 2.5m" tone-mapping="commerce"></model-viewer>' +
          '<span class="model-badge">3D MODEL</span>' +
        '</div>';
    } else {
      modelHtml =
        '<div class="model-area" data-idx="' + idx + '">' +
          '<div class="model-placeholder">' +
            '<div class="cube" data-cube="' + idx + '">' +
              '<div class="cube-face">' + animal.emoji + '</div>' +
              '<div class="cube-face">' + animal.emoji + '</div>' +
              '<div class="cube-face">' + animal.emoji + '</div>' +
              '<div class="cube-face">' + animal.emoji + '</div>' +
              '<div class="cube-face">' + animal.emoji + '</div>' +
              '<div class="cube-face">' + animal.emoji + '</div>' +
            '</div>' +
          '</div>' +
          '<span class="model-badge">DRAG TO ROTATE</span>' +
        '</div>';
    }

    card.innerHTML = modelHtml +
      '<div class="card-body">' +
        '<div class="card-top">' +
          '<span class="card-emoji">' + animal.emoji + '</span>' +
          '<div class="card-titles">' +
            '<div class="card-name">' + animal.name + '</div>' +
            '<div class="card-latin">' + animal.latin + '</div>' +
          '</div>' +
        '</div>' +
        '<div class="card-desc">' + animal.desc + '</div>' +
        '<ul class="facts-list">' + factsHtml + '</ul>' +
        '<button class="card-sound" data-index="' + idx + '">&#128266; Sound</button>' +
      '</div>';

    track.appendChild(card);
  });

  initAllCubeRotation();
}

function initAllCubeRotation() {
  var areas = document.querySelectorAll('.model-area');
  areas.forEach(function(area) {
    var cubeEl = area.querySelector('.cube');
    var rotX = -20, rotY = 0;
    var startX, startY, dragging = false;
    var autoSpin = true;
    var autoFrame;

    function autoRotate() {
      if (autoSpin) {
        rotY += 0.5;
        cubeEl.style.transform = 'rotateX(' + rotX + 'deg) rotateY(' + rotY + 'deg)';
      }
      autoFrame = requestAnimationFrame(autoRotate);
    }
    autoRotate();

    area.addEventListener('pointerdown', function(e) {
      dragging = true;
      autoSpin = false;
      startX = e.clientX;
      startY = e.clientY;
      area.setPointerCapture(e.pointerId);
      e.preventDefault();
    });

    area.addEventListener('pointermove', function(e) {
      if (!dragging) return;
      var dx = e.clientX - startX;
      var dy = e.clientY - startY;
      rotY += dx * 0.8;
      rotX -= dy * 0.8;
      rotX = Math.max(-80, Math.min(80, rotX));
      cubeEl.style.transform = 'rotateX(' + rotX + 'deg) rotateY(' + rotY + 'deg)';
      startX = e.clientX;
      startY = e.clientY;
      e.preventDefault();
    });

    area.addEventListener('pointerup', function(e) {
      dragging = false;
      setTimeout(function() { autoSpin = true; }, 2000);
    });

    area.addEventListener('pointercancel', function() {
      dragging = false;
      setTimeout(function() { autoSpin = true; }, 2000);
    });
  });
}

function scrollBy(dir) {
  var cardW = track.querySelector('.card').offsetWidth + 12;
  track.scrollBy({ left: dir * cardW, behavior: 'smooth' });
}

function bindTouch(el, fn) {
  el.addEventListener('click', function(e) {
    if (e.sourceCapabilities && e.sourceCapabilities.firesTouchEvents) return;
    fn(e);
  });
  el.addEventListener('touchend', function(e) {
    e.preventDefault();
    e.stopPropagation();
    fn(e);
  });
}

bindTouch(document.getElementById('prevBtn'), function() { scrollBy(-1); });
bindTouch(document.getElementById('nextBtn'), function() { scrollBy(1); });

var forestMusic = document.getElementById('forest-music');
var audioToggle = document.getElementById('audioToggle');
var musicPlaying = false;

audioToggle.addEventListener('click', function() {
  if (musicPlaying) {
    forestMusic.pause();
    musicPlaying = false;
    audioToggle.textContent = 'ðŸ”‡ Music';
  } else {
    forestMusic.volume = 0.5;
    forestMusic.play().catch(function(e) {
      console.log('Audio autoplay prevented:', e);
    });
    musicPlaying = true;
    audioToggle.textContent = 'ðŸ”Š Music';
  }
});

bindTouch(document.getElementById('backBtn'), function() { 
  forestMusic.pause();
  location.href = '../index.html'; 
});

window.addEventListener('load', function() {
  setTimeout(function() {
    forestMusic.volume = 0.5;
    forestMusic.play().catch(function(e) {
      console.log('Audio autoplay prevented:', e);
    });
    musicPlaying = true;
  }, 500);
});

document.addEventListener('click', function(e) {
  if (e.sourceCapabilities && e.sourceCapabilities.firesTouchEvents) return;
  var btn = e.target.closest('.card-sound');
  if (btn) playAnimalSound(ANIMALS[parseInt(btn.dataset.index)].sound, btn);
});
document.addEventListener('touchend', function(e) {
  var btn = e.target.closest('.card-sound');
  if (btn) { e.preventDefault(); playAnimalSound(ANIMALS[parseInt(btn.dataset.index)].sound, btn); }
});

function playAnimalSound(cfg, btn) {
  if (btn.classList.contains('playing')) return;
  btn.classList.add('playing');
  try {
    var ac = new (window.AudioContext || window.webkitAudioContext)();
    var now = ac.currentTime;

    if (cfg.type === 'bellow') {
      var o = ac.createOscillator(), g = ac.createGain();
      o.connect(g); g.connect(ac.destination);
      o.type = 'triangle'; o.frequency.setValueAtTime(cfg.freq, now);
      o.frequency.linearRampToValueAtTime(cfg.freq * 0.8, now + cfg.dur);
      var lfo = ac.createOscillator(), lfoG = ac.createGain();
      lfo.connect(lfoG); lfoG.connect(o.frequency);
      lfo.frequency.value = 5; lfoG.gain.value = 15; lfo.start(now);
      g.gain.setValueAtTime(0, now);
      g.gain.linearRampToValueAtTime(0.2, now + 0.1);
      g.gain.linearRampToValueAtTime(0.15, now + cfg.dur * 0.7);
      g.gain.exponentialRampToValueAtTime(0.001, now + cfg.dur);
      o.start(now); o.stop(now + cfg.dur); lfo.stop(now + cfg.dur);
    }
    else if (cfg.type === 'bark') {
      for (var b = 0; b < 3; b++) {
        var o = ac.createOscillator(), g = ac.createGain();
        o.connect(g); g.connect(ac.destination); o.type = 'square';
        var t = now + b * 0.18;
        o.frequency.setValueAtTime(cfg.freq, t);
        o.frequency.exponentialRampToValueAtTime(cfg.freq * 0.5, t + cfg.dur);
        g.gain.setValueAtTime(0.15, t);
        g.gain.exponentialRampToValueAtTime(0.001, t + cfg.dur);
        o.start(t); o.stop(t + cfg.dur);
      }
    }
    else if (cfg.type === 'growl') {
      var o = ac.createOscillator(), g = ac.createGain();
      o.connect(g); g.connect(ac.destination);
      o.type = 'sawtooth'; o.frequency.value = cfg.freq;
      var lfo = ac.createOscillator(), lfoG = ac.createGain();
      lfo.connect(lfoG); lfoG.connect(o.frequency);
      lfo.frequency.value = 3; lfoG.gain.value = 10; lfo.start(now);
      g.gain.setValueAtTime(0, now);
      g.gain.linearRampToValueAtTime(0.12, now + 0.2);
      g.gain.setValueAtTime(0.12, now + cfg.dur * 0.6);
      g.gain.exponentialRampToValueAtTime(0.001, now + cfg.dur);
      o.start(now); o.stop(now + cfg.dur); lfo.stop(now + cfg.dur);
    }
    else if (cfg.type === 'hoot') {
      [cfg.freq, cfg.freq * 0.82].forEach(function(f, i) {
        var o = ac.createOscillator(), g = ac.createGain();
        o.connect(g); g.connect(ac.destination);
        o.type = 'sine'; o.frequency.value = f;
        var t = now + i * (cfg.dur + 0.15);
        g.gain.setValueAtTime(0, t);
        g.gain.linearRampToValueAtTime(0.18, t + 0.05);
        g.gain.setValueAtTime(0.18, t + cfg.dur * 0.7);
        g.gain.exponentialRampToValueAtTime(0.001, t + cfg.dur);
        o.start(t); o.stop(t + cfg.dur);
      });
    }
    else if (cfg.type === 'chitter') {
      for (var c = 0; c < 12; c++) {
        var o = ac.createOscillator(), g = ac.createGain();
        o.connect(g); g.connect(ac.destination); o.type = 'square';
        var t = now + c * cfg.dur;
        o.frequency.value = cfg.freq + Math.random() * 200;
        g.gain.setValueAtTime(0.1, t);
        g.gain.exponentialRampToValueAtTime(0.001, t + cfg.dur * 0.8);
        o.start(t); o.stop(t + cfg.dur);
      }
    }
    else if (cfg.type === 'chirp') {
      for (var ch = 0; ch < 4; ch++) {
        var o = ac.createOscillator(), g = ac.createGain();
        o.connect(g); g.connect(ac.destination); o.type = 'sine';
        var t = now + ch * 0.2;
        o.frequency.setValueAtTime(cfg.freq, t);
        o.frequency.exponentialRampToValueAtTime(cfg.freq * 1.8, t + cfg.dur);
        g.gain.setValueAtTime(0.15, t);
        g.gain.exponentialRampToValueAtTime(0.001, t + cfg.dur);
        o.start(t); o.stop(t + cfg.dur);
      }
    }
    else if (cfg.type === 'slap') {
      var buf = ac.createBuffer(1, ac.sampleRate * cfg.dur, ac.sampleRate);
      var data = buf.getChannelData(0);
      for (var s = 0; s < data.length; s++) data[s] = (Math.random() * 2 - 1) * Math.exp(-s / (ac.sampleRate * 0.02));
      var src = ac.createBufferSource(), g = ac.createGain();
      src.buffer = buf; src.connect(g); g.connect(ac.destination);
      g.gain.setValueAtTime(0.3, now); g.gain.exponentialRampToValueAtTime(0.001, now + cfg.dur);
      src.start(now);
    }
    else if (cfg.type === 'howl') {
      var o = ac.createOscillator(), g = ac.createGain();
      o.connect(g); g.connect(ac.destination); o.type = 'sine';
      o.frequency.setValueAtTime(cfg.freq, now);
      o.frequency.linearRampToValueAtTime(cfg.freq * 2.5, now + cfg.dur * 0.4);
      o.frequency.linearRampToValueAtTime(cfg.freq * 2.2, now + cfg.dur * 0.7);
      o.frequency.linearRampToValueAtTime(cfg.freq * 1.5, now + cfg.dur);
      var lfo = ac.createOscillator(), lfoG = ac.createGain();
      lfo.connect(lfoG); lfoG.connect(o.frequency);
      lfo.frequency.value = 4; lfoG.gain.value = 8; lfo.start(now);
      g.gain.setValueAtTime(0, now);
      g.gain.linearRampToValueAtTime(0.18, now + 0.15);
      g.gain.setValueAtTime(0.18, now + cfg.dur * 0.6);
      g.gain.exponentialRampToValueAtTime(0.001, now + cfg.dur);
      o.start(now); o.stop(now + cfg.dur); lfo.stop(now + cfg.dur);
    }
    else if (cfg.type === 'screech') {
      var o = ac.createOscillator(), g = ac.createGain();
      o.connect(g); g.connect(ac.destination); o.type = 'sawtooth';
      o.frequency.setValueAtTime(cfg.freq, now);
      o.frequency.exponentialRampToValueAtTime(cfg.freq * 0.4, now + cfg.dur);
      g.gain.setValueAtTime(0.1, now); g.gain.exponentialRampToValueAtTime(0.001, now + cfg.dur);
      o.start(now); o.stop(now + cfg.dur);
    }
    else if (cfg.type === 'snuffle') {
      for (var sn = 0; sn < 5; sn++) {
        var buf = ac.createBuffer(1, ac.sampleRate * 0.08, ac.sampleRate);
        var data = buf.getChannelData(0);
        for (var s = 0; s < data.length; s++) data[s] = (Math.random() * 2 - 1) * 0.3;
        var src = ac.createBufferSource(), g = ac.createGain();
        var filt = ac.createBiquadFilter();
        filt.type = 'lowpass'; filt.frequency.value = cfg.freq;
        src.buffer = buf; src.connect(filt); filt.connect(g); g.connect(ac.destination);
        var t = now + sn * 0.12;
        g.gain.setValueAtTime(0.12, t); g.gain.exponentialRampToValueAtTime(0.001, t + 0.08);
        src.start(t);
      }
    }
    else if (cfg.type === 'click') {
      for (var ck = 0; ck < 3; ck++) {
        var o = ac.createOscillator(), g = ac.createGain();
        o.connect(g); g.connect(ac.destination); o.type = 'sine'; o.frequency.value = cfg.freq;
        var t = now + ck * 0.1;
        g.gain.setValueAtTime(0.2, t); g.gain.exponentialRampToValueAtTime(0.001, t + cfg.dur);
        o.start(t); o.stop(t + cfg.dur);
      }
    }
    else if (cfg.type === 'thump') {
      for (var th = 0; th < 3; th++) {
        var o = ac.createOscillator(), g = ac.createGain();
        o.connect(g); g.connect(ac.destination); o.type = 'sine'; o.frequency.value = cfg.freq;
        var t = now + th * 0.2;
        g.gain.setValueAtTime(0.25, t); g.gain.exponentialRampToValueAtTime(0.001, t + cfg.dur);
        o.start(t); o.stop(t + cfg.dur);
      }
    }
    else if (cfg.type === 'roar') {
      var o = ac.createOscillator(), g = ac.createGain();
      o.connect(g); g.connect(ac.destination);
      o.type = 'sawtooth';
      o.frequency.setValueAtTime(cfg.freq, now);
      o.frequency.linearRampToValueAtTime(cfg.freq * 1.8, now + cfg.dur * 0.3);
      o.frequency.linearRampToValueAtTime(cfg.freq * 0.6, now + cfg.dur);
      var lfo = ac.createOscillator(), lfoG = ac.createGain();
      lfo.connect(lfoG); lfoG.connect(o.frequency);
      lfo.frequency.value = 6; lfoG.gain.value = 20; lfo.start(now);
      g.gain.setValueAtTime(0, now);
      g.gain.linearRampToValueAtTime(0.18, now + 0.1);
      g.gain.setValueAtTime(0.18, now + cfg.dur * 0.5);
      g.gain.exponentialRampToValueAtTime(0.001, now + cfg.dur);
      o.start(now); o.stop(now + cfg.dur); lfo.stop(now + cfg.dur);
    }
    else if (cfg.type === 'trumpet') {
      var o = ac.createOscillator(), g = ac.createGain();
      o.connect(g); g.connect(ac.destination);
      o.type = 'square';
      o.frequency.setValueAtTime(cfg.freq, now);
      o.frequency.linearRampToValueAtTime(cfg.freq * 3, now + cfg.dur * 0.4);
      o.frequency.setValueAtTime(cfg.freq * 2.5, now + cfg.dur * 0.6);
      o.frequency.linearRampToValueAtTime(cfg.freq * 2, now + cfg.dur);
      g.gain.setValueAtTime(0, now);
      g.gain.linearRampToValueAtTime(0.15, now + 0.05);
      g.gain.setValueAtTime(0.15, now + cfg.dur * 0.6);
      g.gain.exponentialRampToValueAtTime(0.001, now + cfg.dur);
      o.start(now); o.stop(now + cfg.dur);
    }

    var totalDur = cfg.type === 'howl' ? cfg.dur : cfg.type === 'bark' ? 0.6 : cfg.type === 'chitter' ? 0.8 : cfg.type === 'chirp' ? 0.8 : cfg.type === 'hoot' ? 1.1 : cfg.type === 'snuffle' ? 0.7 : cfg.type === 'click' ? 0.3 : cfg.type === 'thump' ? 0.6 : cfg.type === 'roar' ? cfg.dur : cfg.type === 'trumpet' ? cfg.dur : cfg.dur + 0.1;
    setTimeout(function() { btn.classList.remove('playing'); }, totalDur * 1000);
  } catch (e) {
    btn.classList.remove('playing');
  }
}

buildCards();

var sc = document.getElementById('scene');
for (var i = 0; i < 20; i++) {
  var f = document.createElement('div');
  f.className = 'firefly';
  f.style.left = (Math.random() * 100) + '%';
  f.style.top = (Math.random() * 100) + '%';
  f.style.setProperty('--dur', (3 + Math.random() * 5) + 's');
  f.style.setProperty('--dx', ((Math.random() - .5) * 100) + 'px');
  f.style.setProperty('--dy', ((Math.random() - .5) * 100) + 'px');
  f.style.animationDelay = (Math.random() * 5) + 's';
  sc.appendChild(f);
}
var leafEmojis = ['\uD83C\uDF43', '\uD83C\uDF42', '\uD83C\uDF41'];
for (var i = 0; i < 8; i++) {
  var l = document.createElement('div');
  l.className = 'leaf';
  l.textContent = leafEmojis[Math.floor(Math.random() * leafEmojis.length)];
  l.style.left = (Math.random() * 100) + '%';
  l.style.setProperty('--dur', (8 + Math.random() * 6) + 's');
  l.style.setProperty('--dx', ((Math.random() - .5) * 150) + 'px');
  l.style.animationDelay = (Math.random() * 10) + 's';
  sc.appendChild(l);
}

document.addEventListener('touchstart', function(e) {
  for (var i = 0; i < e.changedTouches.length; i++) {
    var t = e.changedTouches[i];
    var ring = document.createElement('div');
    ring.className = 'touch-ring';
    ring.style.left = t.clientX + 'px';
    ring.style.top = t.clientY + 'px';
    document.body.appendChild(ring);
    ring.addEventListener('animationend', function() { this.remove(); });
  }
}, { passive: true });
</script>
</body>
</html>

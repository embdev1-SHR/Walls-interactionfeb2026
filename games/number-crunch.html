<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Number Crunch</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;touch-action:manipulation;-webkit-tap-highlight-color:transparent}
html,body{width:100%;height:100%;overflow:hidden}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:linear-gradient(135deg,#0a1628 0%,#0d2137 50%,#0a1628 100%);color:white;-webkit-user-select:none;user-select:none}
.app{width:100%;height:100%;display:flex;flex-direction:column;position:relative;z-index:1}
.header{flex-shrink:0;display:flex;align-items:center;justify-content:space-between;padding:12px 20px;gap:12px}
.header h1{font-size:clamp(18px,2.5vw,28px);font-weight:800;color:#38bdf8}
.stats{display:flex;gap:16px;font-size:clamp(12px,1.3vw,16px);font-weight:600}
.stat-val{color:#fbbf24;font-weight:800;font-size:clamp(20px,2.5vw,28px)}
.stat-val.urgent{color:#ef4444;animation:pulseRed 0.5s ease-in-out infinite alternate}
@keyframes pulseRed{0%{transform:scale(1);color:#ef4444}100%{transform:scale(1.15);color:#ff6b6b}}
.combo-display{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);font-size:clamp(48px,8vw,80px);font-weight:900;pointer-events:none;z-index:100;opacity:0;transition:opacity .3s}
.combo-display.show{opacity:1;animation:comboFlash .6s ease}
@keyframes comboFlash{0%{transform:translate(-50%,-50%) scale(.3);opacity:0}50%{transform:translate(-50%,-50%) scale(1.2);opacity:1}100%{transform:translate(-50%,-50%) scale(1);opacity:1}}
.combo-display.x2{color:#22c55e;text-shadow:0 0 30px rgba(34,197,94,.6)}
.combo-display.x3{color:#3b82f6;text-shadow:0 0 30px rgba(59,130,246,.6)}
.combo-display.x4{color:#a855f7;text-shadow:0 0 30px rgba(168,85,247,.6)}
.combo-display.x5{color:#ef4444;text-shadow:0 0 30px rgba(239,68,68,.6)}
.streak-bar{position:absolute;bottom:0;left:0;height:4px;background:linear-gradient(90deg,#22c55e,#3b82f6,#ef4444);transition:width .3s;border-radius:0 2px 2px 0}
.time-bonus-popup{position:fixed;top:20%;left:50%;transform:translateX(-50%);font-size:28px;font-weight:800;color:#22c55e;pointer-events:none;z-index:100;animation:timeBonusFly 1.2s ease forwards}
@keyframes timeBonusFly{0%{opacity:1;transform:translateX(-50%) translateY(0) scale(1)}100%{opacity:0;transform:translateX(-50%) translateY(-60px) scale(1.3)}}

.toolbar-toggle{flex-shrink:0;display:flex;align-items:center;justify-content:center;gap:6px;padding:4px 0;cursor:pointer;font-size:clamp(11px,1.1vw,13px);font-weight:700;color:rgba(255,255,255,.4);transition:color .3s}
.toolbar-toggle:hover{color:rgba(255,255,255,.7)}
.toggle-arrow{font-size:8px;transition:transform .3s;display:inline-block}
.toggle-arrow.open{transform:rotate(180deg)}
.toolbar-drawer{flex-shrink:0;max-height:0;overflow:hidden;transition:max-height .3s ease}
.toolbar-drawer.open{max-height:60px}
.toolbar-options{display:flex;justify-content:center;gap:8px;padding:4px 20px 10px}
.diff-btn{padding:6px 20px;font-size:clamp(11px,1.1vw,14px);font-weight:700;border-radius:50px;cursor:pointer;transition:all .3s;border:2px solid rgba(56,189,248,.2);background:rgba(56,189,248,.06);color:rgba(255,255,255,.5)}
.diff-btn:hover{background:rgba(56,189,248,.12)}
.diff-btn.active{background:rgba(56,189,248,.2);border-color:#38bdf8;color:#38bdf8}

.instructions{flex-shrink:0;text-align:center;padding:0 20px 8px;font-size:clamp(10px,1.1vw,13px);color:rgba(255,255,255,.4)}
.game-area{flex:1;display:flex;align-items:center;justify-content:center;padding:0 20px}
.grid-wrapper{position:relative}
.grid{display:grid;gap:6px}
.cell{display:flex;align-items:center;justify-content:center;font-size:clamp(18px,2.5vw,28px);font-weight:800;border-radius:12px;cursor:pointer;transition:all .2s;position:relative;overflow:hidden}
.cell.empty{background:rgba(255,255,255,.03);border:2px dashed rgba(56,189,248,.1);cursor:default}
.cell.filled{background:rgba(56,189,248,.1);border:2px solid rgba(56,189,248,.25);color:rgba(255,255,255,.85)}
.cell.filled:hover{background:rgba(56,189,248,.2);border-color:rgba(56,189,248,.5);transform:scale(1.05)}
.cell.selected{background:rgba(56,189,248,.3);border-color:#38bdf8;color:#38bdf8;box-shadow:0 0 16px rgba(56,189,248,.3);transform:scale(1.08)}
.cell.merging{animation:mergePop .4s ease}
@keyframes mergePop{0%{transform:scale(1)}40%{transform:scale(1.3)}100%{transform:scale(1)}}
.cell.exploding{animation:explode .5s ease forwards}
@keyframes explode{0%{transform:scale(1);opacity:1}50%{transform:scale(1.5);opacity:.5}100%{transform:scale(0);opacity:0}}
.cell.dropping{animation:dropIn .3s ease}
@keyframes dropIn{0%{transform:translateY(-100%);opacity:0}100%{transform:translateY(0);opacity:1}}
.score-popup{position:absolute;font-size:16px;font-weight:800;color:#fbbf24;pointer-events:none;animation:scoreFly 1s ease forwards;z-index:10}
@keyframes scoreFly{0%{opacity:1;transform:translateY(0)}100%{opacity:0;transform:translateY(-40px)}}
.footer{flex-shrink:0;display:flex;align-items:center;justify-content:center;gap:16px;padding:8px 20px 14px}
.btn-back,.btn-new{padding:8px 26px;font-size:14px;font-weight:600;background:rgba(56,189,248,.1);border:2px solid rgba(56,189,248,.3);color:white;border-radius:50px;cursor:pointer;transition:all .3s}
.btn-back:hover,.btn-new:hover{background:rgba(56,189,248,.2)}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:50;display:none;align-items:center;justify-content:center;flex-direction:column;gap:20px}
.overlay.active{display:flex}
.overlay h2{font-size:clamp(28px,4vw,48px);font-weight:800;color:#38bdf8}
.overlay .final-score{font-size:clamp(48px,8vw,80px);font-weight:800;color:#fbbf24}
.overlay .final-label{font-size:clamp(14px,1.5vw,18px);color:rgba(255,255,255,.5)}
.overlay-btn{padding:12px 32px;font-size:16px;font-weight:700;border-radius:50px;cursor:pointer;transition:all .3s;border:2px solid rgba(56,189,248,.4);background:rgba(56,189,248,.15);color:white}
.overlay-btn:hover{background:rgba(56,189,248,.3)}
.bg-particles{position:fixed;inset:0;z-index:0;pointer-events:none;overflow:hidden}
.bg-dot{position:absolute;width:2px;height:2px;border-radius:50%;background:rgba(56,189,248,.25);animation:float var(--dur) ease-in-out infinite}
@keyframes float{0%,100%{transform:translate(0,0);opacity:.15}50%{transform:translate(var(--dx),var(--dy));opacity:.5}}
.touch-ring{position:fixed;width:60px;height:60px;border:3px solid rgba(56,189,248,.6);border-radius:50%;pointer-events:none;z-index:9999;transform:translate(-50%,-50%) scale(0);animation:ringPop .6s ease forwards}
@keyframes ringPop{0%{transform:translate(-50%,-50%) scale(0);opacity:1}100%{transform:translate(-50%,-50%) scale(2);opacity:0}}
</style>
</head>
<body>
<audio id="number-crunch-music" preload="auto" loop>
  <source src="../assets/Audio/idoberg-space-chords-loop-310493.mp3" type="audio/mpeg">
</audio>
<div class="bg-particles" id="bgP"></div>

<div class="app">
  <div class="header">
    <h1>Number Crunch</h1>
    <div class="stats">
      <div class="stat">Score: <span class="stat-val" id="score">0</span></div>
      <div class="stat">Time: <span class="stat-val" id="timer">90</span>s</div>
      <div class="stat">Combo: <span class="stat-val" id="comboVal">x1</span></div>
      <div class="stat">Best: <span class="stat-val" id="best">0</span></div>
    </div>
  </div>
  <div class="instructions">Tap two adjacent numbers to multiply them. Products over 100 explode for bonus points!</div>
  <div class="game-area">
    <div class="grid-wrapper" id="gridWrapper">
      <div class="grid" id="grid"></div>
    </div>
  </div>
  <div class="toolbar-toggle" id="toolbarToggle">
    <span>Difficulty: Easy</span>
    <span class="toggle-arrow" id="toggleArrow">&#9650;</span>
  </div>
  <div class="toolbar-drawer" id="toolbarDrawer">
    <div class="toolbar-options">
      <div class="diff-btn active" data-diff="easy">Easy</div>
      <div class="diff-btn" data-diff="medium">Medium</div>
      <div class="diff-btn" data-diff="hard">Hard</div>
    </div>
  </div>
  <div class="footer">
    <button class="btn-new" id="btnNew">New Game</button>
    <button class="btn-back" id="btnBack">Back to Menu</button>
  </div>
</div>

<div class="combo-display" id="comboDisplay"></div>

<div class="overlay" id="gameOverlay">
  <h2 id="overTitle">Time's Up!</h2>
  <div class="final-label">Your Score</div>
  <div class="final-score" id="finalScore">0</div>
  <div class="final-label" id="bestMsg"></div>
  <div class="final-label" id="statsMsg"></div>
  <button class="overlay-btn" id="btnRestart">Play Again</button>
  <button class="overlay-btn" id="btnBackOver">Back to Menu</button>
</div>

<script>
var DIFF_CFG = {
  easy: {cols:5, rows:4, maxNum:9, time:120, fillRate:0.6, label:'Easy'},
  medium: {cols:6, rows:5, maxNum:9, time:90, fillRate:0.65, label:'Medium'},
  hard: {cols:7, rows:6, maxNum:12, time:75, fillRate:0.7, label:'Hard'}
};

var difficulty = 'easy';
var COLS, ROWS;
var board = [];
var selectedCell = null;
var score = 0, bestScore = 0;
var timeLeft, timerInterval;
var cellSize;
var combo = 1, streak = 0, lastMergeTime = 0, maxCombo = 1, totalMerges = 0;
var COMBO_WINDOW = 2500;

function applyDifficulty() {
  var cfg = DIFF_CFG[difficulty];
  COLS = cfg.cols; ROWS = cfg.rows;
}

function calcCellSize() {
  var vw = window.innerWidth, vh = window.innerHeight;
  var maxGridW = Math.min(vw * 0.85, 600);
  var maxGridH = vh * 0.50;
  var sw = Math.floor((maxGridW - (COLS - 1) * 6) / COLS);
  var sh = Math.floor((maxGridH - (ROWS - 1) * 6) / ROWS);
  cellSize = Math.min(sw, sh, 80);
}

function rand(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }

function initBoard() {
  var cfg = DIFF_CFG[difficulty];
  board = [];
  for (var r = 0; r < ROWS; r++) {
    board[r] = [];
    for (var c = 0; c < COLS; c++) {
      if (Math.random() < cfg.fillRate) {
        board[r][c] = Math.random() < 0.08 ? 0 : rand(2, cfg.maxNum);
      } else {
        board[r][c] = -1;
      }
    }
  }
}

function hasValidMoves() {
  for (var r = 0; r < ROWS; r++) {
    for (var c = 0; c < COLS; c++) {
      if (board[r][c] <= 0) continue;
      if (c + 1 < COLS && board[r][c+1] > 0) return true;
      if (r + 1 < ROWS && board[r+1][c] > 0) return true;
    }
  }
  return false;
}

function renderGrid() {
  calcCellSize();
  var grid = document.getElementById('grid');
  grid.style.gridTemplateColumns = 'repeat(' + COLS + ',' + cellSize + 'px)';
  grid.style.gridTemplateRows = 'repeat(' + ROWS + ',' + cellSize + 'px)';
  grid.innerHTML = '';

  for (var r = 0; r < ROWS; r++) {
    for (var c = 0; c < COLS; c++) {
      var cell = document.createElement('div');
      cell.dataset.row = r;
      cell.dataset.col = c;
      if (board[r][c] >= 0) {
        cell.className = 'cell filled';
        cell.textContent = board[r][c];
        if (board[r][c] === 0) {
          cell.style.color = 'rgba(255,255,255,.35)';
          cell.style.fontStyle = 'italic';
        }
        if (selectedCell && selectedCell.r === r && selectedCell.c === c) {
          cell.classList.add('selected');
        }
      } else {
        cell.className = 'cell empty';
      }
      grid.appendChild(cell);
    }
  }
}

function isAdjacent(r1, c1, r2, c2) {
  return (Math.abs(r1 - r2) + Math.abs(c1 - c2)) === 1;
}

function handleCellTap(r, c) {
  if (board[r][c] < 0) return;

  if (!selectedCell) {
    if (board[r][c] === 0) return;
    selectedCell = {r: r, c: c};
    renderGrid();
    playTone(400, 0.08);
    return;
  }

  if (selectedCell.r === r && selectedCell.c === c) {
    selectedCell = null;
    renderGrid();
    return;
  }

  if (!isAdjacent(selectedCell.r, selectedCell.c, r, c)) {
    if (board[r][c] === 0) { selectedCell = null; renderGrid(); return; }
    selectedCell = {r: r, c: c};
    renderGrid();
    playTone(400, 0.08);
    return;
  }

  var val1 = board[selectedCell.r][selectedCell.c];
  var val2 = board[r][c];

  if (val1 === 0 || val2 === 0) {
    selectedCell = null;
    renderGrid();
    playTone(250, 0.1);
    return;
  }
  var product = val1 * val2;
  var points = product;
  var now = Date.now();
  totalMerges++;

  if (now - lastMergeTime < COMBO_WINDOW) {
    streak++;
    combo = Math.min(5, 1 + Math.floor(streak / 2));
  } else {
    streak = 1;
    combo = 1;
  }
  lastMergeTime = now;
  if (combo > maxCombo) maxCombo = combo;

  points = Math.floor(points * combo);
  document.getElementById('comboVal').textContent = 'x' + combo;

  if (combo >= 2) showCombo(combo);
  if (streak > 0 && streak % 5 === 0) {
    timeLeft = Math.min(timeLeft + 3, DIFF_CFG[difficulty].time);
    document.getElementById('timer').textContent = timeLeft;
    showTimeBonus('+3s');
  }

  board[selectedCell.r][selectedCell.c] = -1;

  if (product > 100) {
    board[r][c] = -1;
    points += 50 * combo;
    showScorePopup(r, c, '+' + points + ' BOOM! x' + combo);
    playTone(800, 0.3);
  } else {
    board[r][c] = product;
    showScorePopup(r, c, '+' + points + (combo > 1 ? ' x' + combo : ''));
    playTone(600, 0.15);
  }

  score += points;
  document.getElementById('score').textContent = score;
  selectedCell = null;

  renderGrid();
  setTimeout(applyGravity, 200);
  setTimeout(fillEmpty, 500);
}

function showScorePopup(r, c, text) {
  var wrapper = document.getElementById('gridWrapper');
  var popup = document.createElement('div');
  popup.className = 'score-popup';
  popup.textContent = text;
  popup.style.left = (c * (cellSize + 6) + cellSize / 2) + 'px';
  popup.style.top = (r * (cellSize + 6)) + 'px';
  wrapper.appendChild(popup);
  popup.addEventListener('animationend', function() { popup.remove(); });
}

function applyGravity() {
  var moved = false;
  for (var c = 0; c < COLS; c++) {
    for (var r = ROWS - 1; r > 0; r--) {
      if (board[r][c] === -1) {
        for (var above = r - 1; above >= 0; above--) {
          if (board[above][c] >= 0) {
            board[r][c] = board[above][c];
            board[above][c] = -1;
            moved = true;
            break;
          }
        }
      }
    }
  }
  if (moved) renderGrid();
}

function fillEmpty() {
  var cfg = DIFF_CFG[difficulty];
  var filled = false;
  for (var c = 0; c < COLS; c++) {
    if (board[0][c] === -1 && Math.random() < 0.7) {
      board[0][c] = Math.random() < 0.08 ? 0 : rand(2, cfg.maxNum);
      filled = true;
    }
  }
  if (filled) {
    applyGravity();
    renderGrid();
  }
  setTimeout(checkNoMoves, 300);
}

function checkNoMoves() {
  var allFilled = true;
  for (var r = 0; r < ROWS; r++) {
    for (var c = 0; c < COLS; c++) {
      if (board[r][c] === -1) { allFilled = false; break; }
    }
    if (!allFilled) break;
  }
  if (allFilled && !hasValidMoves()) {
    clearInterval(timerInterval);
    document.getElementById('timer').classList.remove('urgent');
    endGame();
  }
}

function showCombo(c) {
  var el = document.getElementById('comboDisplay');
  el.className = 'combo-display show x' + c;
  el.textContent = 'x' + c + ' COMBO!';
  clearTimeout(el._t);
  el._t = setTimeout(function() { el.className = 'combo-display'; }, 900);
}

function showTimeBonus(text) {
  var el = document.createElement('div');
  el.className = 'time-bonus-popup';
  el.textContent = text;
  document.body.appendChild(el);
  el.addEventListener('animationend', function() { el.remove(); });
}

function startTimer() {
  timeLeft = DIFF_CFG[difficulty].time;
  document.getElementById('timer').textContent = timeLeft;
  clearInterval(timerInterval);
  timerInterval = setInterval(function() {
    timeLeft--;
    var timerEl = document.getElementById('timer');
    timerEl.textContent = Math.max(0, timeLeft);
    if (timeLeft <= 10 && timeLeft > 0) {
      timerEl.classList.add('urgent');
      playTone(1000, 0.05);
    } else {
      timerEl.classList.remove('urgent');
    }
    if (Date.now() - lastMergeTime > COMBO_WINDOW && combo > 1) {
      combo = 1; streak = 0;
      document.getElementById('comboVal').textContent = 'x1';
    }
    if (timeLeft <= 0) {
      clearInterval(timerInterval);
      timerEl.classList.remove('urgent');
      endGame();
    }
  }, 1000);
}

function endGame() {
  var noMoves = !hasValidMoves();
  document.getElementById('overTitle').textContent = noMoves ? 'No Moves Left!' : "Time's Up!";
  if (score > bestScore) {
    bestScore = score;
    document.getElementById('best').textContent = bestScore;
    document.getElementById('bestMsg').textContent = 'New Best Score!';
  } else {
    document.getElementById('bestMsg').textContent = 'Best: ' + bestScore;
  }
  document.getElementById('finalScore').textContent = score;
  document.getElementById('statsMsg').textContent = 'Merges: ' + totalMerges + ' | Max Combo: x' + maxCombo;
  document.getElementById('gameOverlay').classList.add('active');
}

function newGame() {
  score = 0; selectedCell = null; combo = 1; streak = 0; lastMergeTime = 0; maxCombo = 1; totalMerges = 0;
  document.getElementById('score').textContent = 0;
  document.getElementById('comboVal').textContent = 'x1';
  document.getElementById('gameOverlay').classList.remove('active');
  applyDifficulty();
  initBoard();
  renderGrid();
  startTimer();
}

function toggleToolbar() {
  document.getElementById('toolbarDrawer').classList.toggle('open');
  document.getElementById('toggleArrow').classList.toggle('open');
}

function playTone(freq, dur) {
  try {
    var ac = new (window.AudioContext || window.webkitAudioContext)();
    var o = ac.createOscillator(), g = ac.createGain();
    o.connect(g); g.connect(ac.destination);
    o.type = 'sine'; o.frequency.value = freq;
    g.gain.setValueAtTime(0.12, ac.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001, ac.currentTime + dur);
    o.start(); o.stop(ac.currentTime + dur);
  } catch(e) {}
}

function bindTouch(el, fn) {
  el.addEventListener('click', function(e) { if (e.sourceCapabilities && e.sourceCapabilities.firesTouchEvents) return; fn(); });
  el.addEventListener('touchend', function(e) { e.preventDefault(); fn(); });
}

bindTouch(document.getElementById('toolbarToggle'), toggleToolbar);

document.querySelectorAll('.diff-btn').forEach(function(btn) {
  bindTouch(btn, function() {
    difficulty = btn.dataset.diff;
    document.querySelectorAll('.diff-btn').forEach(function(b) { b.classList.remove('active'); });
    btn.classList.add('active');
    document.querySelector('#toolbarToggle span:first-child').textContent = 'Difficulty: ' + DIFF_CFG[difficulty].label;
    document.getElementById('toolbarDrawer').classList.remove('open');
    document.getElementById('toggleArrow').classList.remove('open');
    newGame();
  });
});

document.getElementById('grid').addEventListener('click', function(e) {
  if (e.sourceCapabilities && e.sourceCapabilities.firesTouchEvents) return;
  var cell = e.target.closest('.cell');
  if (cell) handleCellTap(parseInt(cell.dataset.row), parseInt(cell.dataset.col));
});
document.getElementById('grid').addEventListener('touchend', function(e) {
  var cell = e.target.closest('.cell');
  if (cell) { e.preventDefault(); handleCellTap(parseInt(cell.dataset.row), parseInt(cell.dataset.col)); }
});

bindTouch(document.getElementById('btnNew'), newGame);
bindTouch(document.getElementById('btnBack'), function() { location.href = '../index.html'; });
bindTouch(document.getElementById('btnRestart'), newGame);
bindTouch(document.getElementById('btnBackOver'), function() { location.href = '../index.html'; });

window.addEventListener('resize', function() { renderGrid(); });

if (new URLSearchParams(window.location.search).get('embed') === '1') {
  document.getElementById('btnBack').style.display = 'none';
  document.querySelector('.footer').style.padding = '4px 10px 6px';
}

applyDifficulty();
newGame();

var bgP = document.getElementById('bgP');
for (var i = 0; i < 40; i++) {
  var d = document.createElement('div'); d.className = 'bg-dot';
  d.style.left=(Math.random()*100)+'%'; d.style.top=(Math.random()*100)+'%';
  d.style.setProperty('--dur',(4+Math.random()*6)+'s');
  d.style.setProperty('--dx',((Math.random()-.5)*60)+'px');
  d.style.setProperty('--dy',((Math.random()-.5)*60)+'px');
  d.style.animationDelay=(Math.random()*5)+'s'; bgP.appendChild(d);
}

document.addEventListener('touchstart',function(e){for(var i=0;i<e.changedTouches.length;i++){var t=e.changedTouches[i];var r=document.createElement('div');r.className='touch-ring';r.style.left=t.clientX+'px';r.style.top=t.clientY+'px';document.body.appendChild(r);r.addEventListener('animationend',function(){this.remove()})}},{passive:true});
</script>
<script>
(function(){
  var m = document.getElementById('number-crunch-music');
  if(!m) return;
  window.addEventListener('load', function(){ setTimeout(function(){ try{ m.volume=0.5; m.play().catch(function(){}); }catch(e){} },500); });
  document.addEventListener('click', function(e){ var b = e.target.closest('.btn-back, .back-button, #backBtn, .goMenuBtn, #goMenuBtn'); if(b){ try{ m.pause(); m.currentTime=0; }catch(e){} } });
})();
</script>
</body>
</html>

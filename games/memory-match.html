<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>City Detective - Evidence Hunt</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{
  font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
  background:#0a1f14;overflow:hidden;color:white;
  -webkit-user-select:none;user-select:none;touch-action:none;
}

/* MENU STYLES */
.menu-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.92);
  display:flex;justify-content:center;align-items:center;z-index:3000;
  animation:fadeIn .5s ease;
}
.menu-box{
  text-align:center;padding:30px 40px;
  background:rgba(15,30,45,.98);backdrop-filter:blur(25px);
  border:3px solid rgba(59,130,246,.5);border-radius:24px;
  max-width:500px;width:90%;max-height:90vh;overflow-y:auto;
  animation:menuIn .6s ease;
}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes menuIn{from{transform:translateY(30px) scale(.95);opacity:0}to{transform:translateY(0) scale(1);opacity:1}}

.menu-title{
  font-size:42px;color:#3b82f6;margin-bottom:8px;
  text-shadow:0 2px 8px rgba(0,0,0,.3);
}
.menu-subtitle{
  font-size:16px;color:rgba(255,255,255,.7);margin-bottom:30px;
}
.game-grid{
  display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));
  gap:20px;margin-bottom:30px;
}
.game-option{
  background:rgba(20,35,50,.8);border-radius:18px;
  padding:25px 20px;cursor:pointer;transition:all .3s;
  border:2px solid rgba(59,130,246,.3);
  display:flex;flex-direction:column;align-items:center;
}
.game-option:hover{
  transform:translateY(-5px);background:rgba(25,45,65,.9);
  border-color:rgba(59,130,246,.6);box-shadow:0 10px 25px rgba(0,0,0,.3);
}
.game-option.selected{
  background:rgba(30,55,80,.95);border-color:#3b82f6;
  box-shadow:0 0 0 3px rgba(59,130,246,.2),0 8px 20px rgba(0,0,0,.4);
}
.game-emoji{
  font-size:48px;margin-bottom:15px;filter:drop-shadow(0 4px 8px rgba(0,0,0,.3));
}
.game-name{
  font-size:20px;font-weight:700;color:white;margin-bottom:8px;
}
.game-desc{
  font-size:13px;color:rgba(255,255,255,.6);text-align:center;line-height:1.4;
}
.menu-btn{
  padding:14px 36px;font-size:17px;font-weight:600;
  background:rgba(59,130,246,.2);border:2px solid rgba(59,130,246,.6);
  color:white;border-radius:50px;cursor:pointer;transition:all .3s;
  -webkit-tap-highlight-color:transparent;touch-action:manipulation;
  margin:0 8px;min-width:140px;
}
.menu-btn:hover{
  background:rgba(59,130,246,.35);transform:scale(1.05);
}
.menu-btn:active{transform:scale(.95)}
.menu-btn.primary{background:rgba(16,185,129,.3);border-color:#10b981;}
.menu-btn.primary:hover{background:rgba(16,185,129,.4);}
.btn-group{display:flex;justify-content:center;gap:12px;margin-top:10px;}

/* GAME STYLES */
.game-wrap{position:relative;width:100vw;height:100vh;overflow:hidden;display:none;}
.game-wrap.active{display:block;}
canvas{position:absolute;inset:0;z-index:0}
#fgCanvas{z-index:40;pointer-events:none}

.clue-btn{
  position:absolute;z-index:30;
  font-size:clamp(32px,5vw,48px);
  cursor:pointer;line-height:1;
  transition:filter .5s ease,opacity .5s ease,transform .5s ease,font-size .5s ease;
  filter:saturate(.15) brightness(.55) hue-rotate(50deg);
  opacity:.32;
}
.clue-btn:hover{
  opacity:.45;
  filter:saturate(.25) brightness(.65) hue-rotate(30deg);
}
.clue-btn.found{
  font-size:clamp(64px,9vw,100px);
  filter:saturate(1) brightness(1) drop-shadow(0 4px 16px rgba(255,255,255,.6));
  opacity:1;cursor:default;
  animation:cluePop .5s ease;
  z-index:45;
}
@keyframes cluePop{
  0%{transform:scale(.3);opacity:0}
  50%{transform:scale(1.4)}
  100%{transform:scale(1);opacity:1}
}

.info-popup{
  position:absolute;z-index:200;
  background:rgba(15,30,45,.94);backdrop-filter:blur(14px);
  border:2px solid rgba(59,130,246,.6);border-radius:16px;
  padding:12px 18px;min-width:180px;max-width:260px;
  pointer-events:none;
  animation:popupIn .4s ease;
  transform:translateX(-50%);
}
@keyframes popupIn{
  0%{transform:translateX(-50%) scale(.5) translateY(10px);opacity:0}
  100%{transform:translateX(-50%) scale(1) translateY(0);opacity:1}
}
.popup-emoji{font-size:32px;text-align:center;display:block;margin-bottom:4px}
.popup-name{font-size:16px;font-weight:700;color:#3b82f6;text-align:center;margin-bottom:4px}
.popup-desc{font-size:12px;color:rgba(255,255,255,.7);text-align:center;line-height:1.4}

.hud{
  position:absolute;top:12px;left:50%;transform:translateX(-50%);
  display:flex;gap:10px;z-index:100;pointer-events:none;
}
.hud-box{
  background:rgba(15,30,45,.92);backdrop-filter:blur(12px);
  border:2px solid rgba(59,130,246,.4);border-radius:12px;
  padding:8px 16px;pointer-events:auto;text-align:center;min-width:80px;
}
.hud-label{font-size:10px;color:rgba(255,255,255,.5);margin-bottom:1px;text-transform:uppercase;letter-spacing:.5px}
.hud-value{font-size:clamp(24px,3.5vw,34px);font-weight:700;color:#3b82f6}

.checklist{
  position:absolute;bottom:12px;left:50%;transform:translateX(-50%);
  background:rgba(15,30,45,.92);backdrop-filter:blur(12px);
  border:2px solid rgba(59,130,246,.4);border-radius:14px;
  padding:8px 14px;z-index:100;
  display:flex;align-items:center;gap:8px;
  max-width:calc(100vw - 240px);
  overflow-x:auto;
}
.checklist::-webkit-scrollbar{height:3px}
.checklist::-webkit-scrollbar-thumb{background:rgba(59,130,246,.3);border-radius:3px}
.cl-item{
  display:flex;align-items:center;gap:5px;
  padding:5px 8px;flex-shrink:0;
  background:rgba(255,255,255,.04);border-radius:8px;
  transition:all .35s ease;
  border:1px solid transparent;
}
.cl-item.found{background:rgba(59,130,246,.2);border-color:rgba(59,130,246,.4)}
.cl-emoji{font-size:20px;filter:grayscale(1) brightness(.5);transition:all .35s;flex-shrink:0}
.cl-item.found .cl-emoji{filter:none;animation:iconPop .5s ease}
@keyframes iconPop{0%,100%{transform:scale(1)}50%{transform:scale(1.35)}}
.cl-name{font-size:11px;color:rgba(255,255,255,.5);white-space:nowrap}
.cl-item.found .cl-name{color:white;font-weight:600}

.btn-corner{
  position:absolute;bottom:12px;z-index:100;
  padding:10px 22px;font-size:14px;font-weight:600;border-radius:50px;
  cursor:pointer;transition:all .3s;backdrop-filter:blur(10px);border:2px solid;
  -webkit-tap-highlight-color:transparent;touch-action:manipulation;
}
.btn-corner:hover{transform:scale(1.05)}
.btn-corner:active{transform:scale(.95)}
.btn-hint{left:14px;background:rgba(255,193,7,.15);border-color:rgba(255,193,7,.4);color:white}
.btn-hint:hover{background:rgba(255,193,7,.25)}
.btn-hint:disabled{opacity:.35;cursor:not-allowed;transform:none}
.btn-menu{right:14px;background:rgba(59,130,246,.12);border-color:rgba(59,130,246,.35);color:white}
.btn-menu:hover{background:rgba(59,130,246,.22)}

.overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.88);
  display:none;justify-content:center;align-items:center;z-index:2000;
}
.overlay.show{display:flex}
.overlay-box{
  text-align:center;padding:36px;
  background:rgba(15,30,45,.96);backdrop-filter:blur(20px);
  border:3px solid rgba(59,130,246,.6);border-radius:22px;
  max-width:440px;animation:boxIn .4s ease;
}
@keyframes boxIn{from{transform:scale(.7);opacity:0}to{transform:scale(1);opacity:1}}
.overlay-title{font-size:38px;color:#3b82f6;margin-bottom:12px}
.overlay-msg{font-size:20px;margin-bottom:18px}
.overlay-stats{font-size:15px;color:rgba(255,255,255,.7);margin-bottom:22px;line-height:1.8}
.overlay-btn{
  padding:12px 32px;font-size:16px;font-weight:600;
  background:rgba(59,130,246,.2);border:2px solid rgba(59,130,246,.6);
  color:white;border-radius:50px;cursor:pointer;transition:all .3s;margin:5px;
  -webkit-tap-highlight-color:transparent;touch-action:manipulation;
}
.overlay-btn:hover{background:rgba(59,130,246,.35);transform:scale(1.05)}
.overlay-btn:active{transform:scale(.95)}

.ripple{
  position:absolute;
  border:3px solid rgba(59,130,246,.7);border-radius:50%;
  pointer-events:none;z-index:60;
  animation:rippleOut .7s ease-out forwards;
}
@keyframes rippleOut{0%{width:0;height:0;opacity:1}100%{width:120px;height:120px;opacity:0}}

.found-burst{
  position:absolute;pointer-events:none;z-index:70;font-size:18px;
  animation:burstOut .8s ease-out forwards;
}
@keyframes burstOut{
  0%{transform:translate(0,0) scale(1);opacity:1}
  100%{transform:translate(var(--bx),var(--by)) scale(.3);opacity:0}
}

.hint-ring{
  position:absolute;pointer-events:none;z-index:55;
  border:3px dashed rgba(255,193,7,.8);border-radius:50%;
  animation:hintPulse 3s ease-out forwards;
}
@keyframes hintPulse{
  0%{opacity:0;transform:translate(-50%,-50%) scale(.5)}
  20%{opacity:1;transform:translate(-50%,-50%) scale(1)}
  80%{opacity:.8;transform:translate(-50%,-50%) scale(1.05)}
  100%{opacity:0;transform:translate(-50%,-50%) scale(1.1)}
}

.touch-ring{
  position:fixed;width:50px;height:50px;
  border:3px solid rgba(59,130,246,.5);border-radius:50%;
  pointer-events:none;z-index:9999;
  transform:translate(-50%,-50%) scale(0);
  animation:ringPop .5s ease forwards;
}
@keyframes ringPop{
  0%{transform:translate(-50%,-50%) scale(0);opacity:1}
  100%{transform:translate(-50%,-50%) scale(2);opacity:0}
}

.case-file{
  position:absolute;top:12px;right:12px;z-index:100;
  background:rgba(15,30,45,.92);backdrop-filter:blur(12px);
  border:2px solid rgba(59,130,246,.4);border-radius:12px;
  padding:8px 16px;pointer-events:auto;
  font-size:12px;color:rgba(255,255,255,.8);
  max-width:200px;
}
.case-title{
  color:#3b82f6;font-weight:bold;margin-bottom:4px;
  text-transform:uppercase;letter-spacing:1px;
}
.case-desc{
  font-size:11px;line-height:1.3;
}
</style>
</head>
<body>
<div class="menu-overlay" id="menuOverlay">
  <div class="menu-box">
    <div class="menu-title">üîç Detective Hunt</div>
    <div class="menu-subtitle">Solve cases by finding hidden clues in the city</div>
    
    <div class="game-grid">
      <div class="game-option" data-game="downtown">
        <div class="game-emoji">üèôÔ∏è</div>
        <div class="game-name">Downtown Mystery</div>
        <div class="game-desc">Find evidence in the bustling city center</div>
      </div>
      
      <div class="game-option" data-game="industrial">
        <div class="game-emoji">üè≠</div>
        <div class="game-name">Industrial District</div>
        <div class="game-desc">Search for clues in the old factory area</div>
      </div>
      
      <div class="game-option" data-game="waterfront">
        <div class="game-emoji">‚öì</div>
        <div class="game-name">Waterfront Case</div>
        <div class="game-desc">Investigate the docks and harbor area</div>
      </div>
      
      <div class="game-option" data-game="residential">
        <div class="game-emoji">üèòÔ∏è</div>
        <div class="game-name">Residential Investigation</div>
        <div class="game-desc">Gather evidence in the quiet neighborhood</div>
      </div>
    </div>
    
    <div class="btn-group">
      <button class="menu-btn" id="startBtn">Start Investigation</button>
      <button class="menu-btn primary" id="howToBtn">Case Briefing</button>
    </div>
  </div>
</div>

<!-- Downtown Game -->
<div class="game-wrap" id="gameDowntown">
  <canvas id="sceneDowntown"></canvas>
  <canvas id="fgCanvasDowntown"></canvas>
  
  <div class="case-file">
    <div class="case-title">Case #247</div>
    <div class="case-desc">The Diamond Heist: Find 8 pieces of evidence from the jewelry store robbery</div>
  </div>
  
  <div class="hud">
    <div class="hud-box">
      <div class="hud-label">Evidence</div>
      <div class="hud-value" id="scoreValDowntown">0/8</div>
    </div>
    <div class="hud-box">
      <div class="hud-label">Time</div>
      <div class="hud-value" id="timeValDowntown">0:00</div>
    </div>
  </div>
  
  <div class="checklist" id="clListDowntown"></div>
  <button class="btn-corner btn-hint" id="hintBtnDowntown">Hint (3)</button>
  <button class="btn-corner btn-menu" id="menuBtnDowntown">Menu</button>
</div>

<!-- Industrial Game -->
<div class="game-wrap" id="gameIndustrial">
  <canvas id="sceneIndustrial"></canvas>
  <canvas id="fgCanvasIndustrial"></canvas>
  
  <div class="case-file">
    <div class="case-title">Case #312</div>
    <div class="case-desc">Missing Blueprints: Find evidence of industrial espionage</div>
  </div>
  
  <div class="hud">
    <div class="hud-box">
      <div class="hud-label">Evidence</div>
      <div class="hud-value" id="scoreValIndustrial">0/8</div>
    </div>
    <div class="hud-box">
      <div class="hud-label">Time</div>
      <div class="hud-value" id="timeValIndustrial">0:00</div>
    </div>
  </div>
  
  <div class="checklist" id="clListIndustrial"></div>
  <button class="btn-corner btn-hint" id="hintBtnIndustrial">Hint (3)</button>
  <button class="btn-corner btn-menu" id="menuBtnIndustrial">Menu</button>
</div>

<!-- Waterfront Game -->
<div class="game-wrap" id="gameWaterfront">
  <canvas id="sceneWaterfront"></canvas>
  <canvas id="fgCanvasWaterfront"></canvas>
  
  <div class="case-file">
    <div class="case-title">Case #428</div>
    <div class="case-desc">Smuggling Ring: Gather evidence from the docks</div>
  </div>
  
  <div class="hud">
    <div class="hud-box">
      <div class="hud-label">Evidence</div>
      <div class="hud-value" id="scoreValWaterfront">0/8</div>
    </div>
    <div class="hud-box">
      <div class="hud-label">Time</div>
      <div class="hud-value" id="timeValWaterfront">0:00</div>
    </div>
  </div>
  
  <div class="checklist" id="clListWaterfront"></div>
  <button class="btn-corner btn-hint" id="hintBtnWaterfront">Hint (3)</button>
  <button class="btn-corner btn-menu" id="menuBtnWaterfront">Menu</button>
</div>

<!-- Residential Game -->
<div class="game-wrap" id="gameResidential">
  <canvas id="sceneResidential"></canvas>
  <canvas id="fgCanvasResidential"></canvas>
  
  <div class="case-file">
    <div class="case-title">Case #539</div>
    <div class="case-desc">Neighborhood Watch: Find clues about the suspicious activities</div>
  </div>
  
  <div class="hud">
    <div class="hud-box">
      <div class="hud-label">Evidence</div>
      <div class="hud-value" id="scoreValResidential">0/8</div>
    </div>
    <div class="hud-box">
      <div class="hud-label">Time</div>
      <div class="hud-value" id="timeValResidential">0:00</div>
    </div>
  </div>
  
  <div class="checklist" id="clListResidential"></div>
  <button class="btn-corner btn-hint" id="hintBtnResidential">Hint (3)</button>
  <button class="btn-corner btn-menu" id="menuBtnResidential">Menu</button>
</div>

<!-- Win Overlay -->
<div class="overlay" id="winOverlay">
  <div class="overlay-box">
    <div class="overlay-title" id="winTitle">Case Solved!</div>
    <div class="overlay-msg" id="winMsg">All evidence collected</div>
    <div class="overlay-stats" id="winStats"></div>
    <button class="overlay-btn" id="playAgainBtn">New Case</button>
    <button class="overlay-btn" id="winMenuBtn" style="margin-left:6px">Headquarters</button>
  </div>
</div>

<script>
// DETECTIVE THEME GAME CONFIGURATION
const GAMES = {
  downtown: {
    id: 'downtown',
    name: 'Downtown Mystery',
    emoji: 'üèôÔ∏è',
    color: '#3b82f6',
    bgColor: '#0f1a2e',
    clues: [
      { emoji:'üíé', name:'Stolen Diamond', desc:'Master-cut diamond missing from the vault' },
      { emoji:'üß§', name:'Glove', desc:'Black leather glove found near broken window' },
      { emoji:'üîë', name:'Skeleton Key', desc:'Key that can open multiple locks' },
      { emoji:'üì±', name:'Burner Phone', desc:'Disposable phone found in alley' },
      { emoji:'üíµ', name:'Marked Bills', desc:'Serial numbers match ransom money' },
      { emoji:'üîç', name:'Magnifying Glass', desc:'Left at the crime scene' },
      { emoji:'üìº', name:'Security Tape', desc:'Partially erased CCTV footage' },
      { emoji:'üñäÔ∏è', name:'Pen', desc:'Custom engraved pen from luxury hotel' }
    ],
    caseTitle: 'Case #247',
    caseDesc: 'The Diamond Heist: Find 8 pieces of evidence from the jewelry store robbery'
  },
  industrial: {
    id: 'industrial',
    name: 'Industrial District',
    emoji: 'üè≠',
    color: '#64748b',
    bgColor: '#1e293b',
    clues: [
      { emoji:'üìú', name:'Blueprints', desc:'Missing factory layout plans' },
      { emoji:'üîß', name:'Tool', desc:'Modified wrench with unusual wear' },
      { emoji:'üíº', name:'Briefcase', desc:'Left behind near the main gate' },
      { emoji:'üì∏', name:'Photos', desc:'Surveillance photos of the facility' },
      { emoji:'üîå', name:'Wire', desc:'Cut electrical wire with unusual markings' },
      { emoji:'üß™', name:'Chemical', desc:'Unlabeled chemical container' },
      { emoji:'üóùÔ∏è', name:'Master Key', desc:'Factory master keycard' },
      { emoji:'üìü', name:'Pager', desc:'Outdated communication device' }
    ],
    caseTitle: 'Case #312',
    caseDesc: 'Missing Blueprints: Find evidence of industrial espionage'
  },
  waterfront: {
    id: 'waterfront',
    name: 'Waterfront Case',
    emoji: '‚öì',
    color: '#0ea5e9',
    bgColor: '#0c4a6e',
    clues: [
      { emoji:'üì¶', name:'Crate', desc:'Unmarked shipping container' },
      { emoji:'üó∫Ô∏è', name:'Map', desc:'Hand-drawn map of the harbor' },
      { emoji:'‚öì', name:'Anchor', desc:'Small boat anchor with fresh scratches' },
      { emoji:'üìÖ', name:'Logbook', desc:'Ship arrival/departure records' },
      { emoji:'üïØÔ∏è', name:'Signal Lamp', desc:'Modified flashlight for Morse code' },
      { emoji:'üßµ', name:'Rope', desc:'New rope with unusual fibers' },
      { emoji:'üì°', name:'Radio', desc:'Marine radio tuned to unusual frequency' },
      { emoji:'üß≠', name:'Compass', desc:'Navigation compass with altered markings' }
    ],
    caseTitle: 'Case #428',
    caseDesc: 'Smuggling Ring: Gather evidence from the docks'
  },
  residential: {
    id: 'residential',
    name: 'Residential Investigation',
    emoji: 'üèòÔ∏è',
    color: '#10b981',
    bgColor: '#064e3b',
    clues: [
      { emoji:'üì¨', name:'Mail', desc:'Unopened letters with suspicious return addresses' },
      { emoji:'üî¶', name:'Flashlight', desc:'Powerful flashlight with red filter' },
      { emoji:'üìπ', name:'Camera', desc:'Hidden surveillance camera' },
      { emoji:'üßæ', name:'Receipt', desc:'Receipt from unusual purchase' },
      { emoji:'üïµÔ∏è', name:'Note', desc:'Cryptic handwritten note' },
      { emoji:'üîê', name:'Lock', desc:'Damaged lock with tool marks' },
      { emoji:'üìª', name:'Radio', desc:'Shortwave radio tuned to odd frequency' },
      { emoji:'üß©', name:'Puzzle', desc:'Jigsaw puzzle with missing pieces' }
    ],
    caseTitle: 'Case #539',
    caseDesc: 'Neighborhood Watch: Find clues about the suspicious activities'
  }
};

// GAME STATE
let currentGame = null;
let gameInstances = {};

// MENU FUNCTIONS
function initMenu() {
  const options = document.querySelectorAll('.game-option');
  options.forEach(option => {
    option.addEventListener('click', function() {
      options.forEach(o => o.classList.remove('selected'));
      this.classList.add('selected');
      currentGame = this.dataset.game;
    });
  });
  
  document.getElementById('startBtn').addEventListener('click', function() {
    if (!currentGame) {
      currentGame = 'downtown';
      document.querySelector(`[data-game="${currentGame}"]`).classList.add('selected');
    }
    startGame(currentGame);
  });
  
  document.getElementById('howToBtn').addEventListener('click', function() {
    alert('CASE BRIEFING:\n\n1. Investigate the scene by clicking/tapping\n2. Find 8 hidden pieces of evidence\n3. Each piece reveals more about the case\n4. Use hints if stuck (3 per case)\n5. Solve the case by collecting all evidence\n\nEach location presents a different mystery to solve!');
  });
  
  // Auto-select first game
  document.querySelector('.game-option').classList.add('selected');
  currentGame = 'downtown';
}

function startGame(gameId) {
  document.getElementById('menuOverlay').style.display = 'none';
  
  // Hide all games, show selected
  document.querySelectorAll('.game-wrap').forEach(wrap => {
    wrap.classList.remove('active');
  });
  
  const gameWrap = document.getElementById(`game${gameId.charAt(0).toUpperCase() + gameId.slice(1)}`);
  gameWrap.classList.add('active');
  
  // Initialize or restart game
  if (!gameInstances[gameId]) {
    gameInstances[gameId] = new DetectiveGame(gameId);
  }
  gameInstances[gameId].init();
}

function returnToMenu() {
  document.querySelectorAll('.game-wrap').forEach(wrap => {
    wrap.classList.remove('active');
  });
  document.getElementById('menuOverlay').style.display = 'flex';
  document.getElementById('winOverlay').classList.remove('show');
}

// DETECTIVE GAME CLASS
class DetectiveGame {
  constructor(gameId) {
    this.gameId = gameId;
    this.config = GAMES[gameId];
    this.W = this.H = 0;
    this.score = 0;
    this.hints = 3;
    this.elapsed = 0;
    this.timer = null;
    this.hiddenClues = [];
    this.environment = null;
    this.initialized = false;
    this.buildings = [];
    this.vehicles = [];
    this.lights = [];
  }
  
  init() {
    if (!this.initialized) {
      this.setupCanvas();
      this.setupEventListeners();
      this.initialized = true;
    }
    this.reset();
  }
  
  setupCanvas() {
    this.cvs = document.getElementById(`scene${this.capitalize(this.gameId)}`);
    this.ctx = this.cvs.getContext('2d');
    this.fgCvs = document.getElementById(`fgCanvas${this.capitalize(this.gameId)}`);
    this.fgCtx = this.fgCvs.getContext('2d');
    this.wrap = document.getElementById(`game${this.capitalize(this.gameId)}`);
    
    window.addEventListener('resize', () => this.resize());
    this.resize();
  }
  
  setupEventListeners() {
    this.addTouchBtn(`hintBtn${this.capitalize(this.gameId)}`, () => this.useHint());
    this.addTouchBtn(`menuBtn${this.capitalize(this.gameId)}`, returnToMenu);
    
    // Game interaction
    this.wrap.addEventListener('touchstart', (e) => {
      e.preventDefault();
      for (let i = 0; i < e.changedTouches.length; i++) {
        const t = e.changedTouches[i];
        this.handleInteraction(t.clientX, t.clientY);
      }
    }, { passive: false });
    
    this.wrap.addEventListener('click', (e) => {
      this.handleInteraction(e.clientX, e.clientY);
    });
  }
  
  handleInteraction(x, y) {
    this.spawnRipple(x, y);
    this.spawnTouchRing(x, y);
    
    // Check if clicked on clue
    for (let i = 0; i < this.hiddenClues.length; i++) {
      const clue = this.hiddenClues[i];
      if (clue.found) continue;
      const rect = clue.el.getBoundingClientRect();
      const cx = rect.left + rect.width / 2;
      const cy = rect.top + rect.height / 2;
      
      if (Math.abs(x - cx) < 40 && Math.abs(y - cy) < 40) {
        this.revealClue(i);
        return;
      }
    }
  }
  
  resize() {
    this.W = this.cvs.width = this.fgCvs.width = window.innerWidth;
    this.H = this.cvs.height = this.fgCvs.height = window.innerHeight;
    this.buildEnvironment();
    this.drawForeground();
    this.placeClues();
  }
  
  buildEnvironment() {
    this.buildings = [];
    this.vehicles = [];
    this.lights = [];
    
    // Create environment based on game type
    switch(this.gameId) {
      case 'downtown':
        this.buildDowntown();
        break;
      case 'industrial':
        this.buildIndustrial();
        break;
      case 'waterfront':
        this.buildWaterfront();
        break;
      case 'residential':
        this.buildResidential();
        break;
    }
  }
  
  buildDowntown() {
    // Skyscrapers
    for (let i = 0; i < 6; i++) {
      const width = 40 + Math.random() * 40;
      const height = 200 + Math.random() * 150;
      const x = (i / 6) * this.W + Math.random() * 50;
      
      this.buildings.push({
        x: x,
        y: this.H - height,
        width: width,
        height: height,
        windows: Math.floor(height / 20),
        color: `hsl(${210 + Math.random() * 20}, 40%, ${30 + Math.random() * 20}%)`
      });
    }
    
    // Street lights
    for (let i = 0; i < 8; i++) {
      this.lights.push({
        x: (i / 8) * this.W,
        y: this.H * 0.7,
        on: Math.random() > 0.5,
        intensity: 0.3 + Math.random() * 0.4
      });
    }
    
    // Vehicles
    for (let i = 0; i < 4; i++) {
      this.vehicles.push({
        x: Math.random() * this.W,
        y: this.H * 0.75,
        width: 40 + Math.random() * 20,
        height: 20,
        speed: 0.5 + Math.random() * 1
      });
    }
  }
  
  buildIndustrial() {
    // Factory buildings
    for (let i = 0; i < 5; i++) {
      const width = 60 + Math.random() * 80;
      const height = 120 + Math.random() * 100;
      const x = (i / 5) * this.W + Math.random() * 30;
      
      this.buildings.push({
        x: x,
        y: this.H - height,
        width: width,
        height: height,
        chimneys: Math.floor(Math.random() * 3),
        color: `hsl(${200 + Math.random() * 20}, 30%, ${25 + Math.random() * 15}%)`
      });
    }
    
    // Smokestacks
    for (let i = 0; i < 3; i++) {
      this.lights.push({
        x: 100 + i * 200,
        y: this.H * 0.3,
        smoke: true,
        intensity: 0.4 + Math.random() * 0.3
      });
    }
  }
  
  buildWaterfront() {
    // Warehouse buildings
    for (let i = 0; i < 4; i++) {
      const width = 80 + Math.random() * 60;
      const height = 100 + Math.random() * 80;
      const x = (i / 4) * this.W + Math.random() * 40;
      
      this.buildings.push({
        x: x,
        y: this.H - height,
        width: width,
        height: height,
        dock: i === 2,
        color: `hsl(${190 + Math.random() * 20}, 35%, ${30 + Math.random() * 15}%)`
      });
    }
    
    // Water
    this.waterLevel = this.H * 0.65;
    
    // Boats
    for (let i = 0; i < 3; i++) {
      this.vehicles.push({
        x: Math.random() * this.W,
        y: this.waterLevel - 20,
        width: 60 + Math.random() * 40,
        height: 30,
        boat: true,
        speed: 0.3 + Math.random() * 0.4
      });
    }
  }
  
  buildResidential() {
    // Houses
    for (let i = 0; i < 6; i++) {
      const width = 50 + Math.random() * 40;
      const height = 80 + Math.random() * 60;
      const x = (i / 6) * this.W + Math.random() * 40;
      
      this.buildings.push({
        x: x,
        y: this.H - height,
        width: width,
        height: height,
        roof: true,
        color: `hsl(${Math.random() * 360}, 40%, ${40 + Math.random() * 20}%)`
      });
    }
    
    // Street lights
    for (let i = 0; i < 6; i++) {
      this.lights.push({
        x: (i / 6) * this.W + 30,
        y: this.H * 0.75,
        on: true,
        intensity: 0.2 + Math.random() * 0.3
      });
    }
    
    // Trees
    for (let i = 0; i < 8; i++) {
      this.lights.push({
        x: 20 + i * 80,
        y: this.H * 0.72,
        tree: true,
        size: 20 + Math.random() * 15
      });
    }
  }
  
  drawForeground() {
    this.fgCtx.clearRect(0, 0, this.W, this.H);
    
    // Top gradient (fog/darkness)
    const topGrad = this.fgCtx.createLinearGradient(0, 0, 0, this.H * 0.2);
    topGrad.addColorStop(0, `rgba(15,30,45,.6)`);
    topGrad.addColorStop(1, 'rgba(15,30,45,0)');
    this.fgCtx.fillStyle = topGrad;
    this.fgCtx.fillRect(0, 0, this.W, this.H * 0.2);
    
    // Bottom gradient (ground fog)
    const btmGrad = this.fgCtx.createLinearGradient(0, this.H * 0.8, 0, this.H);
    btmGrad.addColorStop(0, 'rgba(15,30,45,0)');
    btmGrad.addColorStop(1, `rgba(15,30,45,.4)`);
    this.fgCtx.fillStyle = btmGrad;
    this.fgCtx.fillRect(0, this.H * 0.8, this.W, this.H * 0.2);
  }
  
  drawScene(now) {
    const t = now * 0.001;
    
    // Clear canvas with game-specific background
    this.ctx.fillStyle = this.config.bgColor;
    this.ctx.fillRect(0, 0, this.W, this.H);
    
    // Draw game-specific environment
    this.drawGameEnvironment(t);
    
    // Draw particles (dust, fog, etc.)
    this.drawParticles(t);
  }
  
  drawGameEnvironment(t) {
    switch(this.gameId) {
      case 'downtown':
        this.drawDowntown(t);
        break;
      case 'industrial':
        this.drawIndustrial(t);
        break;
      case 'waterfront':
        this.drawWaterfront(t);
        break;
      case 'residential':
        this.drawResidential(t);
        break;
    }
  }
  
  drawDowntown(t) {
    // Draw sky gradient
    const skyGrad = this.ctx.createLinearGradient(0, 0, 0, this.H * 0.4);
    skyGrad.addColorStop(0, '#1e293b');
    skyGrad.addColorStop(1, '#334155');
    this.ctx.fillStyle = skyGrad;
    this.ctx.fillRect(0, 0, this.W, this.H * 0.4);
    
    // Draw buildings
    this.buildings.forEach(building => {
      // Building body
      this.ctx.fillStyle = building.color;
      this.ctx.fillRect(building.x, building.y, building.width, building.height);
      
      // Windows
      this.ctx.fillStyle = 'rgba(255, 255, 200, 0.6)';
      const windowWidth = 8;
      const windowHeight = 12;
      const windowsPerRow = Math.floor(building.width / (windowWidth + 4));
      const rows = Math.floor(building.height / (windowHeight + 8));
      
      for (let row = 0; row < rows; row++) {
        for (let col = 0; col < windowsPerRow; col++) {
          if (Math.random() > 0.3) { // Random lights on/off
            const wx = building.x + 6 + col * (windowWidth + 4);
            const wy = building.y + 6 + row * (windowHeight + 8);
            this.ctx.fillRect(wx, wy, windowWidth, windowHeight);
          }
        }
      }
    });
    
    // Draw street
    this.ctx.fillStyle = '#475569';
    this.ctx.fillRect(0, this.H * 0.75, this.W, this.H * 0.25);
    
    // Draw street lines
    this.ctx.strokeStyle = '#fbbf24';
    this.ctx.lineWidth = 3;
    this.ctx.setLineDash([20, 15]);
    this.ctx.beginPath();
    this.ctx.moveTo(0, this.H * 0.775);
    this.ctx.lineTo(this.W, this.H * 0.775);
    this.ctx.stroke();
    this.ctx.setLineDash([]);
    
    // Draw street lights
    this.lights.forEach(light => {
      // Pole
      this.ctx.fillStyle = '#64748b';
      this.ctx.fillRect(light.x - 2, light.y, 4, 40);
      
      // Light
      if (light.on) {
        const lightGrad = this.ctx.createRadialGradient(
          light.x, light.y - 5, 0,
          light.x, light.y - 5, 30
        );
        lightGrad.addColorStop(0, `rgba(255, 255, 200, ${light.intensity})`);
        lightGrad.addColorStop(1, 'rgba(255, 255, 200, 0)');
        this.ctx.fillStyle = lightGrad;
        this.ctx.fillRect(light.x - 30, light.y - 35, 60, 40);
        
        this.ctx.fillStyle = '#fbbf24';
        this.ctx.beginPath();
        this.ctx.arc(light.x, light.y - 5, 6, 0, Math.PI * 2);
        this.ctx.fill();
      }
    });
    
    // Draw moving vehicles
    this.vehicles.forEach(vehicle => {
      vehicle.x += vehicle.speed;
      if (vehicle.x > this.W + 50) vehicle.x = -50;
      
      this.ctx.fillStyle = '#dc2626';
      this.ctx.fillRect(vehicle.x, vehicle.y, vehicle.width, vehicle.height);
      
      // Windows
      this.ctx.fillStyle = '#0ea5e9';
      this.ctx.fillRect(vehicle.x + 5, vehicle.y + 2, vehicle.width - 30, 8);
      
      // Lights
      this.ctx.fillStyle = '#fbbf24';
      this.ctx.fillRect(vehicle.x + vehicle.width - 10, vehicle.y + 5, 5, 5);
    });
  }
  
  drawIndustrial(t) {
    // Smoky sky
    const skyGrad = this.ctx.createLinearGradient(0, 0, 0, this.H * 0.5);
    skyGrad.addColorStop(0, '#374151');
    skyGrad.addColorStop(1, '#4b5563');
    this.ctx.fillStyle = skyGrad;
    this.ctx.fillRect(0, 0, this.W, this.H * 0.5);
    
    // Draw factory buildings
    this.buildings.forEach(building => {
      // Main building
      this.ctx.fillStyle = building.color;
      this.ctx.fillRect(building.x, building.y, building.width, building.height);
      
      // Roof details
      this.ctx.fillStyle = '#1f2937';
      this.ctx.fillRect(building.x, building.y, building.width, 5);
      
      // Chimneys
      for (let i = 0; i < building.chimneys; i++) {
        const chimneyX = building.x + 10 + i * 20;
        this.ctx.fillStyle = '#4b5563';
        this.ctx.fillRect(chimneyX, building.y - 30, 8, 30);
      }
      
      // Windows
      this.ctx.fillStyle = 'rgba(255, 255, 200, 0.5)';
      const windowSize = 12;
      const windowsX = Math.floor(building.width / (windowSize + 8));
      const windowsY = Math.floor(building.height / (windowSize + 10));
      
      for (let y = 0; y < windowsY; y++) {
        for (let x = 0; x < windowsX; x++) {
          if (Math.random() > 0.4) {
            const wx = building.x + 10 + x * (windowSize + 8);
            const wy = building.y + 10 + y * (windowSize + 10);
            this.ctx.fillRect(wx, wy, windowSize, windowSize);
          }
        }
      }
    });
    
    // Draw smoke
    this.lights.forEach(light => {
      if (light.smoke) {
        for (let i = 0; i < 3; i++) {
          const smokeX = light.x + Math.sin(t + i) * 20;
          const smokeY = light.y - t * 10 - i * 15;
          const smokeSize = 15 + Math.sin(t * 0.5 + i) * 5;
          
          this.ctx.fillStyle = `rgba(200, 200, 200, ${0.3 - i * 0.1})`;
          this.ctx.beginPath();
          this.ctx.arc(smokeX, smokeY, smokeSize, 0, Math.PI * 2);
          this.ctx.fill();
        }
      }
    });
    
    // Draw ground
    this.ctx.fillStyle = '#6b7280';
    this.ctx.fillRect(0, this.H * 0.7, this.W, this.H * 0.3);
    
    // Draw pipes and industrial details
    this.ctx.strokeStyle = '#9ca3af';
    this.ctx.lineWidth = 8;
    this.ctx.beginPath();
    this.ctx.moveTo(50, this.H * 0.7);
    this.ctx.lineTo(this.W - 50, this.H * 0.7);
    this.ctx.stroke();
  }
  
  drawWaterfront(t) {
    // Sky
    const skyGrad = this.ctx.createLinearGradient(0, 0, 0, this.H * 0.4);
    skyGrad.addColorStop(0, '#0c4a6e');
    skyGrad.addColorStop(1, '#0369a1');
    this.ctx.fillStyle = skyGrad;
    this.ctx.fillRect(0, 0, this.W, this.H * 0.4);
    
    // Water
    this.ctx.fillStyle = '#0284c7';
    this.ctx.fillRect(0, this.waterLevel, this.W, this.H - this.waterLevel);
    
    // Water waves
    this.ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
    this.ctx.lineWidth = 2;
    this.ctx.beginPath();
    for (let x = 0; x < this.W; x += 20) {
      const waveY = this.waterLevel + Math.sin(t + x * 0.01) * 3;
      if (x === 0) this.ctx.moveTo(x, waveY);
      else this.ctx.lineTo(x, waveY);
    }
    this.ctx.stroke();
    
    // Draw warehouses
    this.buildings.forEach(building => {
      // Warehouse
      this.ctx.fillStyle = building.color;
      this.ctx.fillRect(building.x, building.y, building.width, building.height);
      
      // Dock extension
      if (building.dock) {
        this.ctx.fillStyle = '#7c2d12';
        this.ctx.fillRect(building.x - 20, this.waterLevel - 10, building.width + 40, 10);
      }
      
      // Large warehouse doors
      this.ctx.fillStyle = '#1e293b';
      this.ctx.fillRect(building.x + 10, building.y + building.height - 40, building.width - 20, 30);
      
      // Roof
      this.ctx.fillStyle = '#374151';
      this.ctx.fillRect(building.x - 5, building.y, building.width + 10, 5);
    });
    
    // Draw boats
    this.vehicles.forEach(boat => {
      boat.x += boat.speed;
      if (boat.x > this.W + 100) boat.x = -100;
      
      // Boat hull
      this.ctx.fillStyle = '#78350f';
      this.ctx.beginPath();
      this.ctx.moveTo(boat.x, boat.y);
      this.ctx.lineTo(boat.x + boat.width, boat.y);
      this.ctx.lineTo(boat.x + boat.width - 15, boat.y + boat.height);
      this.ctx.lineTo(boat.x + 15, boat.y + boat.height);
      this.ctx.closePath();
      this.ctx.fill();
      
      // Cabin
      this.ctx.fillStyle = '#92400e';
      this.ctx.fillRect(boat.x + 10, boat.y - 15, boat.width - 20, 15);
      
      // Light
      this.ctx.fillStyle = '#fbbf24';
      this.ctx.beginPath();
      this.ctx.arc(boat.x + boat.width - 5, boat.y - 8, 3, 0, Math.PI * 2);
      this.ctx.fill();
    });
    
    // Draw cranes
    this.ctx.fillStyle = '#64748b';
    this.ctx.fillRect(this.W * 0.7, this.waterLevel - 50, 10, 50);
    this.ctx.fillRect(this.W * 0.7 - 20, this.waterLevel - 50, 50, 8);
  }
  
  drawResidential(t) {
    // Evening sky
    const skyGrad = this.ctx.createLinearGradient(0, 0, 0, this.H * 0.5);
    skyGrad.addColorStop(0, '#7c2d12');
    skyGrad.addColorStop(0.5, '#ea580c');
    skyGrad.addColorStop(1, '#fbbf24');
    this.ctx.fillStyle = skyGrad;
    this.ctx.fillRect(0, 0, this.W, this.H * 0.5);
    
    // Draw houses
    this.buildings.forEach(house => {
      // House body
      this.ctx.fillStyle = house.color;
      this.ctx.fillRect(house.x, house.y, house.width, house.height);
      
      // Roof
      if (house.roof) {
        this.ctx.fillStyle = '#7c2d12';
        this.ctx.beginPath();
        this.ctx.moveTo(house.x - 5, house.y);
        this.ctx.lineTo(house.x + house.width / 2, house.y - 20);
        this.ctx.lineTo(house.x + house.width + 5, house.y);
        this.ctx.closePath();
        this.ctx.fill();
      }
      
      // Door
      this.ctx.fillStyle = '#78350f';
      this.ctx.fillRect(house.x + house.width / 2 - 10, house.y + house.height - 30, 20, 30);
      
      // Windows
      this.ctx.fillStyle = 'rgba(255, 255, 200, 0.8)';
      this.ctx.fillRect(house.x + 10, house.y + 20, 15, 20);
      this.ctx.fillRect(house.x + house.width - 25, house.y + 20, 15, 20);
    });
    
    // Draw street
    this.ctx.fillStyle = '#57534e';
    this.ctx.fillRect(0, this.H * 0.75, this.W, this.H * 0.25);
    
    // Draw trees
    this.lights.forEach(item => {
      if (item.tree) {
        // Trunk
        this.ctx.fillStyle = '#78350f';
        this.ctx.fillRect(item.x - 3, item.y, 6, 30);
        
        // Leaves
        this.ctx.fillStyle = '#15803d';
        this.ctx.beginPath();
        this.ctx.arc(item.x, item.y - 10, item.size, 0, Math.PI * 2);
        this.ctx.fill();
      }
    });
    
    // Draw street lights
    this.lights.forEach(light => {
      if (!light.tree && light.on) {
        // Pole
        this.ctx.fillStyle = '#57534e';
        this.ctx.fillRect(light.x - 2, light.y, 4, 35);
        
        // Light glow
        const lightGrad = this.ctx.createRadialGradient(
          light.x, light.y - 8, 0,
          light.x, light.y - 8, 25
        );
        lightGrad.addColorStop(0, `rgba(255, 255, 200, ${light.intensity})`);
        lightGrad.addColorStop(1, 'rgba(255, 255, 200, 0)');
        this.ctx.fillStyle = lightGrad;
        this.ctx.fillRect(light.x - 25, light.y - 33, 50, 30);
        
        // Light bulb
        this.ctx.fillStyle = '#fbbf24';
        this.ctx.beginPath();
        this.ctx.arc(light.x, light.y - 8, 5, 0, Math.PI * 2);
        this.ctx.fill();
      }
    });
  }
  
  drawParticles(t) {
    // Draw ambient particles (dust, fog, etc.)
    for (let i = 0; i < 15; i++) {
      const px = (t * 10 + i * 100) % this.W;
      const py = this.H * 0.3 + Math.sin(t * 0.5 + i) * 50;
      const pr = 1 + Math.sin(t + i) * 0.5;
      
      this.ctx.fillStyle = `rgba(255, 255, 255, ${0.1 + Math.sin(t * 2 + i) * 0.1})`;
      this.ctx.beginPath();
      this.ctx.arc(px, py, pr, 0, Math.PI * 2);
      this.ctx.fill();
    }
  }
  
  placeClues() {
    // Clear existing clues
    this.hiddenClues.forEach(clue => clue.el.remove());
    this.hiddenClues = [];
    
    const margin = 90;
    const minDist = 120;
    const midTop = this.H * 0.25;
    const midBot = this.H * 0.75;
    
    this.config.clues.forEach(def => {
      let x, y, tries = 0;
      do {
        x = margin + Math.random() * (this.W - margin * 2);
        y = midTop + Math.random() * (midBot - midTop);
        tries++;
      } while (tries < 400 && this.hiddenClues.some(c => 
        Math.hypot(c.x - x, c.y - y) < minDist));
      
      this.hiddenClues.push({
        emoji: def.emoji,
        name: def.name,
        desc: def.desc,
        x: x, y: y,
        found: false
      });
    });
    
    // Create DOM elements for clues
    this.hiddenClues.forEach(clue => {
      const el = document.createElement('div');
      el.className = 'clue-btn';
      el.textContent = clue.emoji;
      el.style.left = (clue.x - 24) + 'px';
      el.style.top = (clue.y - 24) + 'px';
      clue.el = el;
      this.wrap.appendChild(el);
    });
    
    // Build checklist
    this.buildChecklist();
  }
  
  buildChecklist() {
    const el = document.getElementById(`clList${this.capitalize(this.gameId)}`);
    el.innerHTML = '';
    this.config.clues.forEach((clue, i) => {
      const item = document.createElement('div');
      item.className = 'cl-item';
      item.id = `cl-${this.gameId}-${i}`;
      item.innerHTML = `<span class="cl-emoji">${clue.emoji}</span><span class="cl-name">${clue.name}</span>`;
      el.appendChild(item);
    });
  }
  
  reset() {
    this.score = 0;
    this.hints = 3;
    this.elapsed = 0;
    
    if (this.timer) clearInterval(this.timer);
    
    // Update UI
    document.getElementById(`scoreVal${this.capitalize(this.gameId)}`).textContent = '0/8';
    document.getElementById(`timeVal${this.capitalize(this.gameId)}`).textContent = '0:00';
    document.getElementById(`hintBtn${this.capitalize(this.gameId)}`).textContent = 'Hint (3)';
    document.getElementById(`hintBtn${this.capitalize(this.gameId)}`).disabled = false;
    
    // Reset clues
    this.hiddenClues.forEach(clue => {
      clue.el.classList.remove('found');
      clue.found = false;
      clue.el.style.fontSize = 'clamp(32px,5vw,48px)';
      clue.el.style.filter = 'saturate(.15) brightness(.55) hue-rotate(50deg)';
      clue.el.style.opacity = '.32';
    });
    
    // Reset checklist
    this.config.clues.forEach((clue, i) => {
      const item = document.getElementById(`cl-${this.gameId}-${i}`);
      if (item) item.classList.remove('found');
    });
    
    // Start timer
    this.startTimer();
    
    // Start animation loop
    if (this.animationId) cancelAnimationFrame(this.animationId);
    this.animationLoop();
  }
  
  startTimer() {
    this.timer = setInterval(() => {
      this.elapsed++;
      const m = Math.floor(this.elapsed / 60);
      const s = this.elapsed % 60;
      document.getElementById(`timeVal${this.capitalize(this.gameId)}`).textContent = 
        m + ':' + (s < 10 ? '0' : '') + s;
    }, 1000);
  }
  
  animationLoop() {
    const loop = (now) => {
      this.drawScene(now);
      this.animationId = requestAnimationFrame(loop);
    };
    this.animationId = requestAnimationFrame(loop);
  }
  
  revealClue(idx) {
    const clue = this.hiddenClues[idx];
    if (clue.found) return;
    clue.found = true;
    clue.el.classList.add('found');
    this.score++;
    
    document.getElementById(`scoreVal${this.capitalize(this.gameId)}`).textContent = 
      this.score + '/8';
    
    // Update checklist
    const clIdx = this.config.clues.findIndex(c => c.name === clue.name);
    if (clIdx >= 0) {
      const item = document.getElementById(`cl-${this.gameId}-${clIdx}`);
      if (item) item.classList.add('found');
    }
    
    this.spawnBurst(clue.x, clue.y);
    this.showPopup(clue);
    this.playChime();
    
    if (this.score === 8) this.endGame();
  }
  
  showPopup(clue) {
    const popup = document.createElement('div');
    popup.className = 'info-popup';
    popup.style.left = clue.x + 'px';
    popup.style.top = Math.max(60, clue.y - 80) + 'px';
    popup.innerHTML = `
      <span class="popup-emoji">${clue.emoji}</span>
      <div class="popup-name">${clue.name}</div>
      <div class="popup-desc">${clue.desc}</div>
    `;
    this.wrap.appendChild(popup);
    setTimeout(() => {
      popup.style.transition = 'opacity .4s';
      popup.style.opacity = '0';
      setTimeout(() => popup.remove(), 400);
    }, 3000);
  }
  
  useHint() {
    if (this.hints <= 0) return;
    const remaining = this.hiddenClues.filter(c => !c.found);
    if (!remaining.length) return;
    const target = remaining[Math.floor(Math.random() * remaining.length)];
    
    const ring = document.createElement('div');
    ring.className = 'hint-ring';
    ring.style.left = target.x + 'px';
    ring.style.top = target.y + 'px';
    ring.style.width = '90px';
    ring.style.height = '90px';
    this.wrap.appendChild(ring);
    ring.addEventListener('animationend', () => ring.remove());
    
    this.hints--;
    const btn = document.getElementById(`hintBtn${this.capitalize(this.gameId)}`);
    btn.textContent = this.hints > 0 ? `Hint (${this.hints})` : 'No Hints';
    if (this.hints <= 0) btn.disabled = true;
  }
  
  endGame() {
    clearInterval(this.timer);
    setTimeout(() => {
      const m = Math.floor(this.elapsed / 60);
      const s = this.elapsed % 60;
      document.getElementById('winTitle').textContent = 'Case Solved!';
      document.getElementById('winMsg').textContent = `${this.config.name} completed`;
      document.getElementById('winStats').innerHTML = `
        Case: ${this.config.caseTitle}<br>
        Time: ${m}:${s < 10 ? '0' : ''}${s}<br>
        Hints used: ${3 - this.hints}<br>
        All evidence collected!
      `;
      document.getElementById('winOverlay').classList.add('show');
    }, 600);
  }
  
  // HELPER FUNCTIONS
  capitalize(str) {
    return str.charAt(0).toUpperCase() + str.slice(1);
  }
  
  addTouchBtn(id, fn) {
    const el = document.getElementById(id);
    if (!el) return;
    el.addEventListener('click', (e) => { 
      if (!(e.sourceCapabilities && e.sourceCapabilities.firesTouchEvents)) fn(); 
    });
    el.addEventListener('touchend', (e) => { 
      e.preventDefault(); 
      e.stopPropagation(); 
      fn(); 
    });
  }
  
  spawnRipple(x, y) {
    const r = document.createElement('div');
    r.className = 'ripple';
    r.style.left = x + 'px';
    r.style.top = y + 'px';
    r.style.marginLeft = '-60px';
    r.style.marginTop = '-60px';
    this.wrap.appendChild(r);
    r.addEventListener('animationend', () => r.remove());
  }
  
  spawnBurst(x, y) {
    const bits = ['\u2B50', '\u2728', '\uD83C\uDF1F', '\uD83D\uDCAB', '\uD83C\uDF3F'];
    for (let i = 0; i < 12; i++) {
      const el = document.createElement('div');
      el.className = 'found-burst';
      el.textContent = bits[i % bits.length];
      el.style.left = x + 'px';
      el.style.top = y + 'px';
      const angle = (i / 12) * Math.PI * 2;
      const dist = 50 + Math.random() * 70;
      el.style.setProperty('--bx', (Math.cos(angle) * dist) + 'px');
      el.style.setProperty('--by', (Math.sin(angle) * dist) + 'px');
      this.wrap.appendChild(el);
      el.addEventListener('animationend', function() { this.remove(); });
    }
  }
  
  spawnTouchRing(x, y) {
    const ring = document.createElement('div');
    ring.className = 'touch-ring';
    ring.style.left = x + 'px';
    ring.style.top = y + 'px';
    document.body.appendChild(ring);
    ring.addEventListener('animationend', () => ring.remove());
  }
  
  playChime() {
    try {
      const ac = new (window.AudioContext || window.webkitAudioContext)();
      [523.25, 659.25, 783.99].forEach((freq, i) => {
        const o = ac.createOscillator(), g = ac.createGain();
        o.connect(g); g.connect(ac.destination);
        o.frequency.value = freq; o.type = 'sine';
        const t0 = ac.currentTime + i * .08;
        g.gain.setValueAtTime(.2, t0);
        g.gain.exponentialRampToValueAtTime(.001, t0 + .3);
        o.start(t0); o.stop(t0 + .3);
      });
    } catch (e) {}
  }
}

// INITIALIZE APPLICATION
document.addEventListener('DOMContentLoaded', () => {
  initMenu();
  
  // Win overlay buttons
  document.getElementById('playAgainBtn').addEventListener('click', () => {
    document.getElementById('winOverlay').classList.remove('show');
    if (currentGame && gameInstances[currentGame]) {
      gameInstances[currentGame].reset();
    }
  });
  
  document.getElementById('winMenuBtn').addEventListener('click', () => {
    document.getElementById('winOverlay').classList.remove('show');
    returnToMenu();
  });
});
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Arithmetica</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;touch-action:manipulation;-webkit-tap-highlight-color:transparent}
html,body{width:100%;height:100%;overflow:hidden}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:linear-gradient(135deg,#1a0a0a 0%,#2d1515 50%,#1a0a0a 100%);color:white;-webkit-user-select:none;user-select:none}
.app{width:100%;height:100%;display:flex;flex-direction:column;position:relative;z-index:1}
.header{flex-shrink:0;display:flex;align-items:center;justify-content:space-between;padding:12px 20px;gap:12px}
.header h1{font-size:clamp(18px,2.5vw,28px);font-weight:800;color:#f87171}
.stats{display:flex;gap:16px;font-size:clamp(12px,1.3vw,16px);font-weight:600}
.stat{display:flex;align-items:center;gap:4px}
.stat-val{color:#fbbf24;font-weight:800;font-size:clamp(20px,2.5vw,28px)}

.toolbar-toggle{flex-shrink:0;display:flex;align-items:center;justify-content:center;gap:6px;padding:4px 0;cursor:pointer;font-size:clamp(11px,1.1vw,13px);font-weight:700;color:rgba(255,255,255,.4);transition:color .3s}
.toolbar-toggle:hover{color:rgba(255,255,255,.7)}
.toggle-arrow{font-size:8px;transition:transform .3s;display:inline-block}
.toggle-arrow.open{transform:rotate(180deg)}
.toolbar-drawer{flex-shrink:0;max-height:0;overflow:hidden;transition:max-height .3s ease}
.toolbar-drawer.open{max-height:60px}
.toolbar-options{display:flex;justify-content:center;gap:8px;padding:4px 20px 10px}
.diff-btn{padding:6px 20px;font-size:clamp(11px,1.1vw,14px);font-weight:700;border-radius:50px;cursor:pointer;transition:all .3s;border:2px solid rgba(248,113,113,.2);background:rgba(248,113,113,.06);color:rgba(255,255,255,.5)}
.diff-btn:hover{background:rgba(248,113,113,.12)}
.diff-btn.active{background:rgba(248,113,113,.2);border-color:#f87171;color:#f87171}

.game-area{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:clamp(16px,3vh,32px);padding:0 20px}
.equation{font-size:clamp(48px,8vw,96px);font-weight:800;text-align:center;min-height:1.2em;color:white;text-shadow:0 4px 20px rgba(0,0,0,.5)}
.equation .op{color:#f87171}
.equation .blank{color:#fbbf24;border-bottom:4px solid #fbbf24;padding:0 8px;min-width:60px;display:inline-block}
.timer-bar{width:clamp(200px,40vw,400px);height:8px;background:rgba(255,255,255,.1);border-radius:4px;overflow:hidden}
.timer-fill{height:100%;background:linear-gradient(90deg,#22c55e,#eab308,#ef4444);border-radius:4px;transition:width .1s linear}
.answers{display:grid;grid-template-columns:1fr 1fr;gap:clamp(10px,1.5vw,16px);width:clamp(280px,50vw,500px)}
.ans-btn{padding:clamp(14px,2.5vh,24px);font-size:clamp(22px,3.5vw,40px);font-weight:800;background:rgba(255,255,255,.06);border:3px solid rgba(248,113,113,.2);border-radius:16px;color:white;cursor:pointer;transition:all .3s;text-align:center}
.ans-btn:hover{background:rgba(248,113,113,.12);border-color:rgba(248,113,113,.5);transform:scale(1.05)}
.ans-btn:active{transform:scale(.95)}
.ans-btn.correct{background:rgba(34,197,94,.25);border-color:#22c55e;color:#22c55e;animation:pulse .4s ease}
.ans-btn.wrong{background:rgba(239,68,68,.25);border-color:#ef4444;color:#ef4444;animation:shake .4s ease}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-8px)}75%{transform:translateX(8px)}}
.streak-display{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);font-size:80px;font-weight:800;color:#fbbf24;opacity:0;pointer-events:none;z-index:100;text-shadow:0 4px 20px rgba(0,0,0,.5)}
.streak-display.show{animation:streakPop .8s ease forwards}
@keyframes streakPop{0%{opacity:0;transform:translate(-50%,-50%) scale(.5)}30%{opacity:1;transform:translate(-50%,-50%) scale(1.3)}100%{opacity:0;transform:translate(-50%,-60%) scale(1)}}
.footer{flex-shrink:0;text-align:center;padding:8px 20px 14px}
.btn-back{padding:8px 26px;font-size:14px;font-weight:600;background:rgba(248,113,113,.1);border:2px solid rgba(248,113,113,.3);color:white;border-radius:50px;cursor:pointer;transition:all .3s}
.btn-back:hover{background:rgba(248,113,113,.2)}
.bg-particles{position:fixed;inset:0;z-index:0;pointer-events:none;overflow:hidden}
.bg-dot{position:absolute;width:3px;height:3px;border-radius:50%;background:rgba(248,113,113,.3);animation:float var(--dur) ease-in-out infinite}
@keyframes float{0%,100%{transform:translate(0,0);opacity:.2}50%{transform:translate(var(--dx),var(--dy));opacity:.6}}
.touch-ring{position:fixed;width:60px;height:60px;border:3px solid rgba(248,113,113,.6);border-radius:50%;pointer-events:none;z-index:9999;transform:translate(-50%,-50%) scale(0);animation:ringPop .6s ease forwards}
@keyframes ringPop{0%{transform:translate(-50%,-50%) scale(0);opacity:1}100%{transform:translate(-50%,-50%) scale(2);opacity:0}}
</style>
</head>
<body>
<audio id="arithmetica-music" preload="auto" loop>
  <source src="../assets/Audio/idoberg-space-chords-loop-310493.mp3" type="audio/mpeg">
</audio>
<div class="bg-particles" id="bgP"></div>
<div class="streak-display" id="streakDisplay"></div>

<div class="app">
  <div class="header">
    <h1>Arithmetica</h1>
    <div class="stats">
      <div class="stat">Score: <span class="stat-val" id="score">0</span></div>
      <div class="stat">Streak: <span class="stat-val" id="streak">0</span></div>
      <div class="stat">Q: <span class="stat-val" id="qNum">1</span></div>
    </div>
  </div>
  <div class="game-area">
    <div class="equation" id="equation"></div>
    <div class="timer-bar"><div class="timer-fill" id="timerFill"></div></div>
    <div class="answers" id="answers"></div>
  </div>
  <div class="toolbar-toggle" id="toolbarToggle">
    <span>Difficulty: Easy</span>
    <span class="toggle-arrow" id="toggleArrow">&#9650;</span>
  </div>
  <div class="toolbar-drawer" id="toolbarDrawer">
    <div class="toolbar-options">
      <div class="diff-btn active" data-diff="easy">Easy</div>
      <div class="diff-btn" data-diff="medium">Medium</div>
      <div class="diff-btn" data-diff="hard">Hard</div>
    </div>
  </div>
  <div class="footer">
    <button class="btn-back" id="btnBack">Back to Menu</button>
  </div>
</div>

<script>
var difficulty = 'easy';
var score = 0, streakCount = 0, questionNum = 0;
var timerInterval, timeLeft, maxTime = 10;
var currentAnswer = 0;
var answering = false;

var DIFF = {
  easy: {maxNum: 15, ops: ['+','-'], time: 12, label: 'Easy'},
  medium: {maxNum: 50, ops: ['+','-','x'], time: 10, label: 'Medium'},
  hard: {maxNum: 100, ops: ['+','-','x','\u00F7'], time: 8, label: 'Hard'}
};

function rand(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }

function generateQuestion() {
  var cfg = DIFF[difficulty];
  var op = cfg.ops[rand(0, cfg.ops.length - 1)];
  var a, b, answer;

  if (op === '+') {
    a = rand(1, cfg.maxNum); b = rand(1, cfg.maxNum);
    answer = a + b;
  } else if (op === '-') {
    a = rand(1, cfg.maxNum); b = rand(1, a);
    answer = a - b;
  } else if (op === 'x') {
    a = rand(2, 12); b = rand(2, 12);
    answer = a * b;
  } else {
    b = rand(2, 12); answer = rand(1, 12);
    a = b * answer;
  }

  currentAnswer = answer;
  return {a: a, op: op, b: b, answer: answer};
}

function generateOptions(answer) {
  var opts = [answer];
  while (opts.length < 4) {
    var offset = rand(1, Math.max(5, Math.floor(answer * 0.3)));
    var wrong = answer + (Math.random() < 0.5 ? offset : -offset);
    if (wrong < 0) wrong = answer + offset;
    if (opts.indexOf(wrong) === -1) opts.push(wrong);
  }
  for (var i = opts.length - 1; i > 0; i--) {
    var j = rand(0, i);
    var tmp = opts[i]; opts[i] = opts[j]; opts[j] = tmp;
  }
  return opts;
}

function showQuestion() {
  questionNum++;
  document.getElementById('qNum').textContent = questionNum;
  answering = false;

  var q = generateQuestion();
  document.getElementById('equation').innerHTML =
    q.a + ' <span class="op">' + q.op + '</span> ' + q.b + ' = <span class="blank">?</span>';

  var opts = generateOptions(q.answer);
  var container = document.getElementById('answers');
  container.innerHTML = '';

  opts.forEach(function(val) {
    var btn = document.createElement('div');
    btn.className = 'ans-btn';
    btn.textContent = val;
    btn.addEventListener('click', function(e) {
      if (e.sourceCapabilities && e.sourceCapabilities.firesTouchEvents) return;
      checkAnswer(val, btn);
    });
    btn.addEventListener('touchend', function(e) {
      e.preventDefault();
      checkAnswer(val, btn);
    });
    container.appendChild(btn);
  });

  startTimer();
}

function checkAnswer(val, btn) {
  if (answering) return;
  answering = true;
  clearInterval(timerInterval);

  if (val === currentAnswer) {
    btn.classList.add('correct');
    var bonus = Math.max(1, Math.ceil(timeLeft));
    score += 10 + bonus;
    streakCount++;
    if (streakCount >= 3 && streakCount % 3 === 0) {
      score += streakCount * 5;
      showStreak(streakCount);
    }
    playTone(523, 0.15);
  } else {
    btn.classList.add('wrong');
    document.querySelectorAll('.ans-btn').forEach(function(b) {
      if (parseInt(b.textContent) === currentAnswer) b.classList.add('correct');
    });
    streakCount = 0;
    playTone(200, 0.2);
  }

  document.getElementById('score').textContent = score;
  document.getElementById('streak').textContent = streakCount;
  setTimeout(showQuestion, 1000);
}

function startTimer() {
  var cfg = DIFF[difficulty];
  timeLeft = cfg.time;
  maxTime = cfg.time;
  document.getElementById('timerFill').style.width = '100%';

  clearInterval(timerInterval);
  timerInterval = setInterval(function() {
    timeLeft -= 0.1;
    var pct = Math.max(0, (timeLeft / maxTime) * 100);
    document.getElementById('timerFill').style.width = pct + '%';
    if (timeLeft <= 0) {
      clearInterval(timerInterval);
      if (!answering) {
        answering = true;
        streakCount = 0;
        document.getElementById('streak').textContent = 0;
        document.querySelectorAll('.ans-btn').forEach(function(b) {
          if (parseInt(b.textContent) === currentAnswer) b.classList.add('correct');
        });
        playTone(200, 0.2);
        setTimeout(showQuestion, 1000);
      }
    }
  }, 100);
}

function showStreak(n) {
  var el = document.getElementById('streakDisplay');
  el.textContent = n + 'x Streak!';
  el.classList.remove('show');
  void el.offsetWidth;
  el.classList.add('show');
}

function resetGame() {
  score = 0; streakCount = 0; questionNum = 0;
  document.getElementById('score').textContent = 0;
  document.getElementById('streak').textContent = 0;
  showQuestion();
}

function toggleToolbar() {
  var drawer = document.getElementById('toolbarDrawer');
  var arrow = document.getElementById('toggleArrow');
  drawer.classList.toggle('open');
  arrow.classList.toggle('open');
}

function playTone(freq, dur) {
  try {
    var ac = new (window.AudioContext || window.webkitAudioContext)();
    var o = ac.createOscillator(), g = ac.createGain();
    o.connect(g); g.connect(ac.destination);
    o.type = 'sine'; o.frequency.value = freq;
    g.gain.setValueAtTime(0.15, ac.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001, ac.currentTime + dur);
    o.start(); o.stop(ac.currentTime + dur);
  } catch(e) {}
}

function bindTouch(el, fn) {
  el.addEventListener('click', function(e) { if (e.sourceCapabilities && e.sourceCapabilities.firesTouchEvents) return; fn(); });
  el.addEventListener('touchend', function(e) { e.preventDefault(); fn(); });
}

bindTouch(document.getElementById('toolbarToggle'), toggleToolbar);

document.querySelectorAll('.diff-btn').forEach(function(btn) {
  bindTouch(btn, function() {
    difficulty = btn.dataset.diff;
    document.querySelectorAll('.diff-btn').forEach(function(b) { b.classList.remove('active'); });
    btn.classList.add('active');
    document.querySelector('#toolbarToggle span:first-child').textContent = 'Difficulty: ' + DIFF[difficulty].label;
    document.getElementById('toolbarDrawer').classList.remove('open');
    document.getElementById('toggleArrow').classList.remove('open');
    resetGame();
  });
});

var arithmeticaMusic = document.getElementById('arithmetica-music');
bindTouch(document.getElementById('btnBack'), function() { 
  arithmeticaMusic.pause();
  location.href = '../index.html'; 
});

window.addEventListener('load', function() {
  setTimeout(function() {
    arithmeticaMusic.volume = 0.5;
    arithmeticaMusic.play().catch(function(e) {
      console.log('Audio autoplay prevented:', e);
    });
  }, 500);
});

showQuestion();

if (new URLSearchParams(window.location.search).get('embed') === '1') {
  document.getElementById('btnBack').style.display = 'none';
  document.querySelector('.footer').style.padding = '4px 10px 6px';
}

var bgP = document.getElementById('bgP');
for (var i = 0; i < 30; i++) {
  var d = document.createElement('div'); d.className = 'bg-dot';
  d.style.left = (Math.random()*100)+'%'; d.style.top = (Math.random()*100)+'%';
  d.style.setProperty('--dur',(4+Math.random()*6)+'s');
  d.style.setProperty('--dx',((Math.random()-.5)*60)+'px');
  d.style.setProperty('--dy',((Math.random()-.5)*60)+'px');
  d.style.animationDelay=(Math.random()*5)+'s'; bgP.appendChild(d);
}

document.addEventListener('touchstart',function(e){for(var i=0;i<e.changedTouches.length;i++){var t=e.changedTouches[i];var r=document.createElement('div');r.className='touch-ring';r.style.left=t.clientX+'px';r.style.top=t.clientY+'px';document.body.appendChild(r);r.addEventListener('animationend',function(){this.remove()})}},{passive:true});
</script>
</body>
</html>
